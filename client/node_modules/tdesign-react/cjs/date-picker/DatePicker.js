/**
 * tdesign v0.22.1
 * (c) 2022 tdesign
 * @license MIT
 */

'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var defineProperty = require('../_chunks/dep-449daca3.js');
var slicedToArray = require('../_chunks/dep-fa36e79f.js');
var React = require('react');
var isObject = require('../_chunks/dep-735b841a.js');
var _baseGetTag = require('../_chunks/dep-0e3f1753.js');
var isObjectLike$1 = require('../_chunks/dep-48870ae5.js');
var _baseUnary = require('../_chunks/dep-07d4a79b.js');
var _nodeUtil = require('../_chunks/dep-fb89215e.js');
var isArray = require('../_chunks/dep-9125a75e.js');
var isString = require('../_chunks/dep-0705da20.js');
var dayjs = require('dayjs');
var classNames = require('classnames');
var tdesignIconsReact = require('tdesign-icons-react');
var locale_LocalReceiver = require('../locale/LocalReceiver.js');
var _util_useConfig = require('../_util/useConfig.js');
var _util_useCommonClassName = require('../_util/useCommonClassName.js');
var _util_useClickOutside = require('../_util/useClickOutside.js');
var popup_index = require('../popup/index.js');
var input_index = require('../input/index.js');
var button_index = require('../button/index.js');
var datePicker_base_CalendarPresets = require('./base/CalendarPresets.js');
var datePicker_panel_Date = require('./panel/Date.js');
var datePicker_panel_DateRange = require('./panel/DateRange.js');
var timePicker_panel_TimePickerPanel = require('../time-picker/panel/TimePickerPanel.js');
var timePicker_panel_TimePickerRangePanel = require('../time-picker/panel/TimePickerRangePanel.js');
require('../_chunks/dep-045b87c1.js');
require('../_chunks/dep-a7666a95.js');
require('../config-provider/ConfigContext.js');
require('../locale/zh_CN.js');
require('../popup/Popup.js');
require('react-transition-group');
require('react-popper');
require('../_util/useDefault.js');
require('../_util/noop.js');
require('../_util/composeRefs.js');
require('../_util/usePrevious.js');
require('../popup/Portal.js');
require('react-dom');
require('../popup/hooks/useTriggerProps.js');
require('../popup/hooks/usePopupCssTransition.js');
require('../input/Input.js');
require('../_chunks/dep-e03ca79d.js');
require('../_chunks/dep-1bafebb1.js');
require('../_util/forwardRefWithStatics.js');
require('hoist-non-react-statics');
require('../input/InputGroup.js');
require('../_util/useDefaultValue.js');
require('../button/Button.js');
require('../_util/useRipple.js');
require('../_util/setStyle.js');
require('../loading/index.js');
require('../loading/loading.js');
require('../_util/dom.js');
require('raf');
require('../_util/easing.js');
require('../common/Portal.js');
require('../loading/gradient.js');
require('../loading/plugin.js');
require('./base/Header.js');
require('./base/Table.js');
require('./base/Cell.js');
require('./utils.js');
require('../_chunks/dep-871fbfc7.js');
require('../_chunks/dep-c7adf4af.js');
require('../_chunks/dep-059e74d9.js');
require('../_chunks/dep-6681bc7b.js');
require('../_chunks/dep-f445e9bb.js');
require('../_chunks/dep-72511bfe.js');
require('../_chunks/dep-7d00ab60.js');
require('../_chunks/dep-5e46865d.js');
require('../_chunks/dep-8bb9b7ba.js');
require('../_chunks/dep-9c74d22d.js');
require('../time-picker/panel/SinglePanel.js');
require('../_chunks/dep-228a3548.js');
require('../_chunks/dep-99d6d655.js');
require('../_chunks/dep-7a0cfc4c.js');
require('../_chunks/dep-bc486aab.js');
require('../_chunks/dep-942a7aba.js');
require('../time-picker/interfaces.js');
require('../time-picker/consts.js');

function _interopDefaultLegacy (e) { return e && typeof e === 'object' && 'default' in e ? e : { 'default': e }; }

var React__default = /*#__PURE__*/_interopDefaultLegacy(React);
var dayjs__default = /*#__PURE__*/_interopDefaultLegacy(dayjs);
var classNames__default = /*#__PURE__*/_interopDefaultLegacy(classNames);

var baseGetTag = _baseGetTag._baseGetTag,
    isObjectLike = isObjectLike$1.isObjectLike_1;
/** `Object#toString` result references. */

var dateTag = '[object Date]';
/**
 * The base implementation of `_.isDate` without Node.js optimizations.
 *
 * @private
 * @param {*} value The value to check.
 * @returns {boolean} Returns `true` if `value` is a date object, else `false`.
 */

function baseIsDate$1(value) {
  return isObjectLike(value) && baseGetTag(value) == dateTag;
}

var _baseIsDate = baseIsDate$1;

var baseIsDate = _baseIsDate,
    baseUnary = _baseUnary._baseUnary,
    nodeUtil = _nodeUtil._nodeUtil.exports;
/* Node.js helper references. */

var nodeIsDate = nodeUtil && nodeUtil.isDate;
/**
 * Checks if `value` is classified as a `Date` object.
 *
 * @static
 * @memberOf _
 * @since 0.1.0
 * @category Lang
 * @param {*} value The value to check.
 * @returns {boolean} Returns `true` if `value` is a date object, else `false`.
 * @example
 *
 * _.isDate(new Date);
 * // => true
 *
 * _.isDate('Mon April 23 2012');
 * // => false
 */

var isDate = nodeIsDate ? baseUnary(nodeIsDate) : baseIsDate;
var isDate_1 = isDate;

var isBetween$1 = {exports: {}};

(function (module, exports) {
  !function (e, t) {
    module.exports = t() ;
  }(_baseGetTag.commonjsGlobal, function () {

    return function (e, t, i) {
      t.prototype.isBetween = function (e, t, s, f) {
        var n = i(e),
            o = i(t),
            r = "(" === (f = f || "()")[0],
            u = ")" === f[1];
        return (r ? this.isAfter(n, s) : !this.isBefore(n, s)) && (u ? this.isBefore(o, s) : !this.isAfter(o, s)) || (r ? this.isBefore(n, s) : !this.isAfter(n, s)) && (u ? this.isAfter(o, s) : !this.isBefore(o, s));
      };
    };
  });
})(isBetween$1);

var isBetween = isBetween$1.exports;

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { defineProperty._defineProperty(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }
dayjs__default["default"].extend(isBetween);
var TIME_FORMAT = "HH:mm:ss";

var DatePicker = function DatePicker(props) {
  var className = props.className,
      style = props.style,
      allowInput = props.allowInput,
      clearable = props.clearable,
      disabled = props.disabled,
      disableDate = props.disableDate,
      enableTimePicker = props.enableTimePicker,
      format = props.format,
      inputProps = props.inputProps,
      mode = props.mode,
      popupProps = props.popupProps,
      prefixIcon = props.prefixIcon,
      presets = props.presets,
      range = props.range,
      size = props.size,
      suffixIcon = props.suffixIcon,
      value = props.value,
      defaultValue = props.defaultValue,
      firstDayOfWeek = props.firstDayOfWeek,
      onChange = props.onChange;

  var _useLocaleReceiver = locale_LocalReceiver.useLocaleReceiver("datePicker"),
      _useLocaleReceiver2 = slicedToArray._slicedToArray(_useLocaleReceiver, 2),
      local = _useLocaleReceiver2[0],
      t = _useLocaleReceiver2[1];

  var selectTimeText = t(local.selectTime);
  var selectDateText = t(local.selectDate);
  var confirmText = t(local.confirm);
  var rangeSeparatorText = t(local.rangeSeparator);
  var placeholder = t(local.placeholder[mode]);

  var _useConfig = _util_useConfig["default"](),
      classPrefix = _useConfig.classPrefix;

  var CLASSNAMES = _util_useCommonClassName["default"]();
  var datePickerRef = React.useRef(null);
  var dropdownPopupRef = React.useRef(null);
  var inputRef = React.useRef(null);

  var _useState = React.useState(false),
      _useState2 = slicedToArray._slicedToArray(_useState, 2),
      popupShow = _useState2[0],
      setPopupShow = _useState2[1];

  var _useState3 = React.useState(false),
      _useState4 = slicedToArray._slicedToArray(_useState3, 2),
      timePanelShow = _useState4[0],
      setTimePanelShow = _useState4[1];

  var _useState5 = React.useState(""),
      _useState6 = slicedToArray._slicedToArray(_useState5, 2),
      timeValue = _useState6[0],
      setTimeValue = _useState6[1];

  var _useState7 = React.useState([]),
      _useState8 = slicedToArray._slicedToArray(_useState7, 2),
      timeRangeValue = _useState8[0],
      setTimeRangeValue = _useState8[1];

  var _useState9 = React.useState(new Date()),
      _useState10 = slicedToArray._slicedToArray(_useState9, 2),
      start = _useState10[0],
      setStart = _useState10[1];

  var _useState11 = React.useState(new Date()),
      _useState12 = slicedToArray._slicedToArray(_useState11, 2),
      end = _useState12[0],
      setEnd = _useState12[1];

  var _useState13 = React.useState(""),
      _useState14 = slicedToArray._slicedToArray(_useState13, 2),
      formattedValue = _useState14[0],
      setFormattedValue = _useState14[1];

  var _useState15 = React.useState([]),
      _useState16 = slicedToArray._slicedToArray(_useState15, 2),
      selectedDates = _useState16[0],
      setSelectedDates = _useState16[1];

  var isControlled = typeof value !== "undefined";

  function isValidDate(date) {
    if (isArray.isArray_1(date) && isDate_1(new Date(date[0])) && isDate_1(new Date(date[1]))) return true;
    if (isString.isString_1(date) && isDate_1(new Date(date))) return true;
    return false;
  }

  function initDatePicker() {
    var val = value || defaultValue;

    if (val && isValidDate(val)) {
      var startVal = range ? new Date(val[0]) : new Date(val);
      var endVal = range ? new Date(val[1]) : new Date(val);
      setStart(startVal);
      setEnd(endVal);
      setTimeValue(dayjs__default["default"](startVal).format(TIME_FORMAT));
      setTimeRangeValue([dayjs__default["default"](startVal).format(TIME_FORMAT), dayjs__default["default"](endVal).format(TIME_FORMAT)]);
      setSelectedDates(range ? [val[0], val[1]] : [val]);
    }
  }

  _util_useClickOutside["default"]([datePickerRef, dropdownPopupRef], function () {
    close();
  });
  React.useEffect(function () {
    initDatePicker();
  }, []);
  React.useEffect(function () {
    updateFormatValue();
  }, [selectedDates, value]);

  function updateFormatValue() {
    var dates = selectedDates;

    if (isControlled) {
      if (Array.isArray(value)) {
        dates = value.map(function (d) {
          return d ? new Date(d) : new Date();
        });
      } else {
        dates = value ? [new Date(value)] : [];
      }
    }

    var selectedFmtDates = dates.map(function (d) {
      return formatDate(d);
    });
    var pickerMode = mode;
    if (range) pickerMode = "range";
    var nextValue = "";

    switch (pickerMode) {
      case "date":
      case "month":
      case "year":
        dates[0] && setStart(new Date(dates[0]));
        nextValue = selectedFmtDates.join("");
        break;

      case "range":
        if (selectedFmtDates.length > 1) {
          setStart(new Date(dates[0]));
          setEnd(new Date(dates[1]));
          nextValue = [selectedFmtDates[0], selectedFmtDates[1]].join(rangeSeparatorText);
        }

        break;
    }

    setFormattedValue(nextValue);
  }

  function showPopup() {
    if (disabled) return;
    setPopupShow(true);
  }

  function formatDate(date) {
    var dateFormat = format || "";
    var arrTime = ["H", "h", "m", "s"];
    var hasTime = arrTime.some(function (f) {
      return String(dateFormat).includes(f);
    });

    if (enableTimePicker && !hasTime) {
      dateFormat = [dateFormat, TIME_FORMAT].join(" ");
    }

    var d1 = new Date(date);
    return dayjs__default["default"](d1).format(dateFormat);
  }

  function close() {
    if (disabled) return;
    setPopupShow(false);
    setTimePanelShow(false);
  }

  function handleClear(_ref) {
    var e = _ref.e;
    e.stopPropagation();
    close();

    if (!disabled) {
      setStart(new Date());
      setEnd(new Date());
      setSelectedDates([]);
      setFormattedValue("");
      setTimeValue("00:00:00");
      setTimeRangeValue(["00:00:00", "00:00:00"]);
      submitInput([], true);
    }
  }

  function submitInput(selectedDates2) {
    var triggerChange = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;
    var pickerMode = range ? "range" : mode;

    switch (pickerMode) {
      case "date":
      case "month":
      case "year":
        triggerChange && (onChange === null || onChange === void 0 ? void 0 : onChange(selectedDates2[0]));
        break;

      case "range":
        triggerChange && (onChange === null || onChange === void 0 ? void 0 : onChange(selectedDates2));
        break;
    }
  }

  function clickRange(value2) {
    var nextDates = [];

    if (Array.isArray(value2)) {
      nextDates.push.apply(nextDates, [dayjs__default["default"](value2[0]).toDate(), dayjs__default["default"](value2[1]).toDate()]);
      setStart(nextDates[0]);
      setEnd(nextDates[1]);
    } else {
      nextDates.push(dayjs__default["default"](value2).toDate());
      setStart(nextDates[0]);
      setEnd(nextDates[0]);
    }

    setSelectedDates(nextDates);
    clickedApply(!enableTimePicker, nextDates);
  }

  function clickedApply() {
    var closePicker = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : true;
    var nextDates = arguments.length > 1 ? arguments[1] : undefined;
    var dates = nextDates || selectedDates;
    submitInput(dates.map(function (d) {
      return formatDate(d);
    }), true);
    closePicker && close();
  }

  function toggleTime() {
    setTimeValue(dayjs__default["default"](start).format(TIME_FORMAT));
    setTimeRangeValue([dayjs__default["default"](start).format(TIME_FORMAT), dayjs__default["default"](end).format(TIME_FORMAT)]);
    setTimePanelShow(!timePanelShow);
  }

  function handleTimePick(value2) {
    if (Array.isArray(value2)) {
      var _value = slicedToArray._slicedToArray(value2, 2),
          startTime = _value[0],
          endTime = _value[1];

      var _startTime$split = startTime.split(":"),
          _startTime$split2 = slicedToArray._slicedToArray(_startTime$split, 3),
          startHour = _startTime$split2[0],
          startMinute = _startTime$split2[1],
          startSecond = _startTime$split2[2];

      var startDate = new Date(start);
      startDate.setHours(startHour);
      startDate.setMinutes(startMinute);
      startDate.setSeconds(startSecond);

      var _endTime$split = endTime.split(":"),
          _endTime$split2 = slicedToArray._slicedToArray(_endTime$split, 3),
          endHour = _endTime$split2[0],
          endMinute = _endTime$split2[1],
          endSecond = _endTime$split2[2];

      var endDate = new Date(end);
      endDate.setHours(endHour);
      endDate.setMinutes(endMinute);
      endDate.setSeconds(endSecond);
      setTimeRangeValue(value2);
      clickRange([startDate, endDate]);
    } else {
      var _value2$split = value2.split(":"),
          _value2$split2 = slicedToArray._slicedToArray(_value2$split, 3),
          hour = _value2$split2[0],
          minute = _value2$split2[1],
          second = _value2$split2[2];

      var _startDate = new Date(start);

      _startDate.setHours(hour);

      _startDate.setMinutes(minute);

      _startDate.setSeconds(second);

      setTimeValue(value2);
      dateClick(_startDate);
    }
  }

  function dateClick(value2) {
    var pickerMode = mode;
    if (range) pickerMode = "range";

    switch (pickerMode) {
      case "year":
      case "month":
      case "date":
        {
          if (value2 instanceof Date) {
            if (!isControlled) {
              setStart(value2);
              setEnd(value2);
            }

            setSelectedDates([value2]);
            clickedApply(!enableTimePicker, [value2]);
          }

          break;
        }

      case "range":
        {
          if (Array.isArray(value2)) {
            if (!isControlled) {
              setStart(value2[0]);
              setEnd(value2[1]);
            }

            setSelectedDates(value2);
            clickedApply(!enableTimePicker, value2);
          }

          break;
        }
    }
  }

  function isEnabled(value2) {
    if (!disableDate) return true;
    var isEnabled2 = true;

    if (typeof disableDate === "function") {
      return !disableDate(value2);
    }

    if (Array.isArray(disableDate)) {
      var isIncludes = false;
      var formatedDisabledDate = disableDate.map(function (item) {
        return dayjs__default["default"](item, format);
      });
      formatedDisabledDate.forEach(function (item) {
        if (item.isSame(dayjs__default["default"](value2))) {
          isIncludes = true;
        }
      });
      return !isIncludes;
    }

    var from = disableDate.from,
        to = disableDate.to,
        before = disableDate.before,
        after = disableDate.after;

    if (from && to) {
      var compareMin = dayjs__default["default"](new Date(from));
      var compareMax = dayjs__default["default"](new Date(to));
      return !dayjs__default["default"](value2).isBetween(compareMin, compareMax, mode, "[]");
    }

    var min = before ? new Date(before) : null;
    var max = after ? new Date(after) : null;

    if (max && min) {
      var _compareMin = dayjs__default["default"](new Date(min));

      var _compareMax = dayjs__default["default"](new Date(max));

      isEnabled2 = dayjs__default["default"](value2).isBetween(_compareMin, _compareMax, mode, "[]");
    } else if (min) {
      var _compareMin2 = dayjs__default["default"](new Date(min));

      isEnabled2 = !dayjs__default["default"](value2).isBefore(_compareMin2, mode);
    } else if (max) {
      var _compareMax2 = dayjs__default["default"](new Date(max));

      isEnabled2 = !dayjs__default["default"](value2).isAfter(_compareMax2, mode);
    }

    return isEnabled2;
  }

  function renderContent() {
    var _classNames;

    var pickerStyles = classNames__default["default"]("".concat(classPrefix, "-date-picker__container"), (_classNames = {}, defineProperty._defineProperty(_classNames, "".concat(classPrefix, "-date-picker--open"), popupShow), defineProperty._defineProperty(_classNames, "".concat(classPrefix, "-date-picker--range"), range), _classNames));
    var panelProps = {
      mode: mode,
      firstDayOfWeek: firstDayOfWeek === void 0 ? 1 : firstDayOfWeek,
      onChange: dateClick,
      disableDate: function disableDate(d) {
        return !isEnabled(d);
      },
      minDate: isObject.isObject_1(disableDate) && "before" in disableDate ? new Date(disableDate.before) : null,
      maxDate: isObject.isObject_1(disableDate) && "after" in disableDate ? new Date(disableDate.after) : null
    };
    var panelComponent = range ? /* @__PURE__ */React__default["default"].createElement(datePicker_panel_DateRange["default"], _objectSpread(_objectSpread({}, panelProps), {}, {
      value: [start, end]
    })) : /* @__PURE__ */React__default["default"].createElement(datePicker_panel_Date["default"], _objectSpread(_objectSpread({}, panelProps), {}, {
      value: start
    }));
    var timepickerComponent = range ? /* @__PURE__ */React__default["default"].createElement(timePicker_panel_TimePickerRangePanel["default"], {
      value: timeRangeValue,
      onChange: handleTimePick
    }) : /* @__PURE__ */React__default["default"].createElement(timePicker_panel_TimePickerPanel["default"], {
      value: timeValue,
      onChange: handleTimePick
    });
    return /* @__PURE__ */React__default["default"].createElement("div", {
      ref: dropdownPopupRef,
      className: pickerStyles
    }, enableTimePicker && timePanelShow && /* @__PURE__ */React__default["default"].createElement("div", null, timepickerComponent), !timePanelShow && panelComponent, (!!presets || enableTimePicker) && /* @__PURE__ */React__default["default"].createElement("div", {
      className: "".concat(classPrefix, "-date-picker__footer")
    }, /* @__PURE__ */React__default["default"].createElement(datePicker_base_CalendarPresets["default"], {
      presets: presets,
      onClickRange: clickRange
    }), enableTimePicker && /* @__PURE__ */React__default["default"].createElement("div", {
      className: "".concat(classPrefix, "-date-picker--apply")
    }, enableTimePicker && /* @__PURE__ */React__default["default"].createElement(button_index.Button, {
      theme: "primary",
      variant: "text",
      onClick: toggleTime
    }, timePanelShow ? selectDateText : selectTimeText), /* @__PURE__ */React__default["default"].createElement(button_index.Button, {
      theme: "primary",
      onClick: function onClick() {
        return clickedApply(true);
      }
    }, confirmText))));
  }

  var triggerClassName = classNames__default["default"]("".concat(classPrefix, "-form-controls"), defineProperty._defineProperty({}, CLASSNAMES.STATUS.active, popupShow));
  var defaultSuffixIcon = enableTimePicker ? /* @__PURE__ */React__default["default"].createElement(tdesignIconsReact.TimeIcon, null) : /* @__PURE__ */React__default["default"].createElement(tdesignIconsReact.CalendarIcon, null);
  var datePickerClassName = classNames__default["default"]("".concat(classPrefix, "-date-picker"), className, CLASSNAMES.SIZE[size], defineProperty._defineProperty({}, "".concat(classPrefix, "-date-picker--month-picker"), mode === "year" || mode === "month"));
  return /* @__PURE__ */React__default["default"].createElement("div", {
    className: datePickerClassName,
    ref: datePickerRef,
    style: style
  }, /* @__PURE__ */React__default["default"].createElement(popup_index.Popup, _objectSpread({
    trigger: "context-menu",
    placement: "bottom-left",
    visible: popupShow,
    content: renderContent(),
    overlayClassName: "".concat(classPrefix, "-date-picker"),
    className: "".concat(classPrefix, "-date-picker__popup-reference"),
    expandAnimation: true,
    destroyOnClose: true
  }, popupProps), /* @__PURE__ */React__default["default"].createElement("div", {
    className: triggerClassName,
    onClick: showPopup
  }, /* @__PURE__ */React__default["default"].createElement(input_index.Input, _objectSpread({
    ref: inputRef,
    size: size,
    value: formattedValue,
    disabled: disabled,
    clearable: clearable,
    placeholder: placeholder,
    readonly: !allowInput,
    onClear: handleClear,
    prefixIcon: prefixIcon,
    suffixIcon: suffixIcon || defaultSuffixIcon
  }, inputProps)))));
};

DatePicker.displayName = "DatePicker";
DatePicker.defaultProps = {
  format: "YYYY-MM-DD",
  mode: "month",
  placeholder: "\u8BF7\u9009\u62E9",
  size: "medium"
};

exports["default"] = DatePicker;
//# sourceMappingURL=DatePicker.js.map
