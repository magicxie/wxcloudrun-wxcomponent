/**
 * tdesign v0.22.1
 * (c) 2022 tdesign
 * @license MIT
 */

'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var slicedToArray = require('../_chunks/dep-fa36e79f.js');
var defineProperty = require('../_chunks/dep-449daca3.js');
var React = require('react');
var classNames = require('classnames');
var isEmpty = require('../_chunks/dep-72f8673c.js');
var isFunction = require('../_chunks/dep-1bafebb1.js');
var flatten = require('../_chunks/dep-d2229c5d.js');
var _util_useConfig = require('../_util/useConfig.js');
var _util_noop = require('../_util/noop.js');
var _util_forwardRefWithStatics = require('../_util/forwardRefWithStatics.js');
var form_FormContext = require('./FormContext.js');
var form_FormItem = require('./FormItem.js');
require('../_chunks/dep-045b87c1.js');
require('../_chunks/dep-c82d4aac.js');
require('../_chunks/dep-0e3f1753.js');
require('../_chunks/dep-a7666a95.js');
require('../_chunks/dep-72511bfe.js');
require('../_chunks/dep-48870ae5.js');
require('../_chunks/dep-07d4a79b.js');
require('../_chunks/dep-fb89215e.js');
require('../_chunks/dep-69abf228.js');
require('../_chunks/dep-20e76bfc.js');
require('../_chunks/dep-735b841a.js');
require('../_chunks/dep-c5449fbe.js');
require('../_chunks/dep-9125a75e.js');
require('../_chunks/dep-f445e9bb.js');
require('../_chunks/dep-9e6db8fb.js');
require('../_chunks/dep-4a02b995.js');
require('../config-provider/ConfigContext.js');
require('../locale/zh_CN.js');
require('hoist-non-react-statics');
require('tdesign-icons-react');
require('../checkbox/index.js');
require('../_chunks/dep-8027cfc6.js');
require('../common/Check.js');
require('../_chunks/dep-e03ca79d.js');
require('../_util/helper.js');
require('../_chunks/dep-3ca698ba.js');
require('../_chunks/dep-7a0cfc4c.js');
require('../_chunks/dep-9c74d22d.js');
require('../_chunks/dep-bc486aab.js');
require('../_chunks/dep-c7adf4af.js');
require('../_util/useDefault.js');
require('../_chunks/dep-f0639562.js');
require('../upload/index.js');
require('../upload/upload.js');
require('../_chunks/dep-8f3deb2a.js');
require('../_chunks/dep-b000fdae.js');
require('../_chunks/dep-66fbd01b.js');
require('../_chunks/dep-4f605641.js');
require('../_chunks/dep-6681bc7b.js');
require('../_chunks/dep-c57ef5b6.js');
require('../_chunks/dep-7d00ab60.js');
require('../_chunks/dep-af921283.js');
require('../_chunks/dep-59b9b071.js');
require('../_chunks/dep-942a7aba.js');
require('../_chunks/dep-5e46865d.js');
require('../_chunks/dep-8bb9b7ba.js');
require('../dialog/index.js');
require('../dialog/Dialog.js');
require('../_chunks/dep-0705da20.js');
require('../locale/LocalReceiver.js');
require('../button/index.js');
require('../button/Button.js');
require('../_util/useRipple.js');
require('../_util/setStyle.js');
require('../loading/index.js');
require('../loading/loading.js');
require('../_util/dom.js');
require('raf');
require('../_util/easing.js');
require('../common/Portal.js');
require('react-dom');
require('../loading/gradient.js');
require('../loading/plugin.js');
require('../dialog/RenderDialog.js');
require('react-transition-group');
require('../_util/useSetState.js');
require('../dialog/plugin.js');
require('../upload/dragger.js');
require('../upload/themes/dragger-progress.js');
require('../upload/util.js');
require('../upload/upload-trigger.js');
require('../upload/tips.js');
require('../_common/js/upload/xhr.js');
require('../upload/themes/single-file.js');
require('../upload/themes/image-card.js');
require('../upload/boolean-render.js');
require('../upload/themes/flow-list/index.js');
require('../upload/themes/flow-list/img-list.js');
require('../upload/themes/flow-list/file-list.js');
require('../upload/hooks/useDefaultValue.js');
require('../tag/index.js');
require('../tag/Tag.js');
require('../tag/CheckTag.js');
require('./formModel.js');

function _interopDefaultLegacy (e) { return e && typeof e === 'object' && 'default' in e ? e : { 'default': e }; }

var React__default = /*#__PURE__*/_interopDefaultLegacy(React);
var classNames__default = /*#__PURE__*/_interopDefaultLegacy(classNames);

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { defineProperty._defineProperty(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }
var Form = _util_forwardRefWithStatics["default"](function (props, ref) {
  var style = props.style,
      className = props.className,
      _props$labelWidth = props.labelWidth,
      labelWidth = _props$labelWidth === void 0 ? "100px" : _props$labelWidth,
      statusIcon = props.statusIcon,
      _props$labelAlign = props.labelAlign,
      labelAlign = _props$labelAlign === void 0 ? "right" : _props$labelAlign,
      _props$layout = props.layout,
      layout = _props$layout === void 0 ? "vertical" : _props$layout,
      _props$size = props.size,
      size = _props$size === void 0 ? "medium" : _props$size,
      _props$colon = props.colon,
      colon = _props$colon === void 0 ? false : _props$colon,
      _props$requiredMark = props.requiredMark,
      requiredMark = _props$requiredMark === void 0 ? true : _props$requiredMark,
      scrollToFirstError = props.scrollToFirstError,
      _props$showErrorMessa = props.showErrorMessage,
      showErrorMessage = _props$showErrorMessa === void 0 ? true : _props$showErrorMessa,
      _props$resetType = props.resetType,
      resetType = _props$resetType === void 0 ? "empty" : _props$resetType,
      rules = props.rules,
      children = props.children,
      onSubmit = props.onSubmit,
      onReset = props.onReset,
      _props$onValuesChange = props.onValuesChange,
      onValuesChange = _props$onValuesChange === void 0 ? _util_noop["default"] : _props$onValuesChange;

  var _useConfig = _util_useConfig["default"](),
      classPrefix = _useConfig.classPrefix;

  var formClass = classNames__default["default"](className, "".concat(classPrefix, "-form"), defineProperty._defineProperty({}, "".concat(classPrefix, "-form-inline"), layout === "inline"));
  var formItemsRef = React.useRef([]);
  var FORM_ITEM_CLASS_PREFIX = "".concat(classPrefix, "-form-item__");

  function getFirstError(r) {
    var _r$firstKey$;

    if (r === true) return;

    var _Object$keys = Object.keys(r),
        _Object$keys2 = slicedToArray._slicedToArray(_Object$keys, 1),
        firstKey = _Object$keys2[0];

    if (scrollToFirstError) {
      scrollTo(".".concat(FORM_ITEM_CLASS_PREFIX + firstKey));
    }

    return (_r$firstKey$ = r[firstKey][0]) === null || _r$firstKey$ === void 0 ? void 0 : _r$firstKey$.message;
  }

  function scrollTo(selector) {
    var dom = document.querySelector(selector);
    var behavior = scrollToFirstError;
    dom && dom.scrollIntoView({
      behavior: behavior
    });
  }

  function submitHandler(e) {
    e === null || e === void 0 ? void 0 : e.preventDefault();
    validate().then(function (r) {
      getFirstError(r);
      onSubmit === null || onSubmit === void 0 ? void 0 : onSubmit({
        validateResult: r,
        e: e
      });
    });
  }

  function resetHandler(e) {
    e === null || e === void 0 ? void 0 : e.preventDefault();
    formItemsRef.current.forEach(function (_ref) {
      var formItemRef = _ref.current;
      if (!isFunction.isFunction_1(formItemRef.resetField)) return;
      formItemRef.resetField();
    });
    onReset === null || onReset === void 0 ? void 0 : onReset({
      e: e
    });
  }

  function validate(param) {
    function needValidate(name, fields2) {
      if (!fields2 || !Array.isArray(fields2)) return true;
      return fields2.indexOf(name) !== -1;
    }

    var _ref2 = param || {},
        fields = _ref2.fields,
        _ref2$trigger = _ref2.trigger,
        trigger = _ref2$trigger === void 0 ? "all" : _ref2$trigger;

    var list = formItemsRef.current.filter(function (_ref3) {
      var formItemRef = _ref3.current;
      return isFunction.isFunction_1(formItemRef.validate) && needValidate(formItemRef.name, fields);
    }).map(function (_ref4) {
      var formItemRef = _ref4.current;
      return formItemRef.validate(trigger);
    });
    return new Promise(function (resolve) {
      Promise.all(flatten.flatten_1(list)).then(function (arr) {
        var r = arr.reduce(function (r2, err) {
          return Object.assign(r2 || {}, err);
        }, {});
        Object.keys(r).forEach(function (key) {
          if (r[key] === true) {
            delete r[key];
          }
        });
        resolve(isEmpty.isEmpty_1(r) ? true : r);
      })["catch"](console.error);
    });
  }

  function getAllFieldsValue() {
    var fieldsValue = {};
    formItemsRef.current.forEach(function (_ref5) {
      var formItemRef = _ref5.current;

      if (formItemRef.name) {
        fieldsValue[formItemRef.name] = formItemRef.value;
      }
    });
    return fieldsValue;
  }

  function getFieldValue(name) {
    if (!name) return null;
    var target = formItemsRef.current.find(function (_ref6) {
      var formItemRef = _ref6.current;
      return formItemRef.name === name;
    });
    return target && target.value;
  }

  function setFieldsValue() {
    var fileds = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
    var formItemsMap = formItemsRef.current.reduce(function (acc, _ref7) {
      var currItem = _ref7.current;
      var name = currItem.name;
      return _objectSpread(_objectSpread({}, acc), {}, defineProperty._defineProperty({}, name, currItem));
    }, {});
    Object.keys(fileds).forEach(function (key) {
      var _formItemsMap$key;

      (_formItemsMap$key = formItemsMap[key]) === null || _formItemsMap$key === void 0 ? void 0 : _formItemsMap$key.setValue(fileds[key]);
    });
  }

  function setFields() {
    var fileds = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];
    if (!Array.isArray(fileds)) throw new Error("setFields \u53C2\u6570\u9700\u8981 Array \u7C7B\u578B");
    var formItemsMap = formItemsRef.current.reduce(function (acc, _ref8) {
      var currItem = _ref8.current;
      var name = currItem.name;
      return _objectSpread(_objectSpread({}, acc), {}, defineProperty._defineProperty({}, name, currItem));
    }, {});
    fileds.forEach(function (filed) {
      var _formItemsMap$name;

      var name = filed.name,
          value = filed.value,
          status = filed.status;
      (_formItemsMap$name = formItemsMap[name]) === null || _formItemsMap$name === void 0 ? void 0 : _formItemsMap$name.setField({
        value: value,
        status: status
      });
    });
  }

  React.useImperativeHandle(ref, function () {
    return {
      submit: submitHandler,
      reset: resetHandler,
      getFieldValue: getFieldValue,
      setFieldsValue: setFieldsValue,
      setFields: setFields,
      validate: validate,
      getAllFieldsValue: getAllFieldsValue
    };
  });

  function onFormItemValueChange(changedValue) {
    var allFileds = getAllFieldsValue();
    onValuesChange(changedValue, allFileds);
  }

  return /* @__PURE__ */React__default["default"].createElement(form_FormContext["default"].Provider, {
    value: {
      labelWidth: labelWidth,
      statusIcon: statusIcon,
      labelAlign: labelAlign,
      layout: layout,
      size: size,
      colon: colon,
      requiredMark: requiredMark,
      showErrorMessage: showErrorMessage,
      scrollToFirstError: scrollToFirstError,
      resetType: resetType,
      rules: rules,
      formItemsRef: formItemsRef,
      onFormItemValueChange: onFormItemValueChange
    }
  }, /* @__PURE__ */React__default["default"].createElement("form", {
    className: formClass,
    style: style,
    onSubmit: submitHandler,
    onReset: resetHandler,
    ref: ref
  }, children));
}, {
  FormItem: form_FormItem["default"]
});
Form.displayName = "Form";

exports["default"] = Form;
//# sourceMappingURL=Form.js.map
