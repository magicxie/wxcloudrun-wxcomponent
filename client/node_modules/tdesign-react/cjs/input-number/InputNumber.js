/**
 * tdesign v0.22.1
 * (c) 2022 tdesign
 * @license MIT
 */

'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var defineProperty = require('../_chunks/dep-449daca3.js');
var slicedToArray = require('../_chunks/dep-fa36e79f.js');
var objectWithoutProperties = require('../_chunks/dep-e03ca79d.js');
var React = require('react');
var classNames = require('classnames');
var _util_useConfig = require('../_util/useConfig.js');
var _util_useCommonClassName = require('../_util/useCommonClassName.js');
var _util_useUpdateEffect = require('../_util/useUpdateEffect.js');
var inputNumber_StepHandler = require('./StepHandler.js');
var inputNumber_utils_numberUtils = require('./utils/numberUtils.js');
var input_index = require('../input/index.js');
require('../_chunks/dep-045b87c1.js');
require('../config-provider/ConfigContext.js');
require('../locale/zh_CN.js');
require('tdesign-icons-react');
require('../button/index.js');
require('../button/Button.js');
require('../_util/noop.js');
require('../_util/useRipple.js');
require('../_util/setStyle.js');
require('../loading/index.js');
require('../loading/loading.js');
require('../_util/dom.js');
require('raf');
require('../_chunks/dep-0705da20.js');
require('../_chunks/dep-0e3f1753.js');
require('../_chunks/dep-a7666a95.js');
require('../_chunks/dep-9125a75e.js');
require('../_chunks/dep-48870ae5.js');
require('../_util/easing.js');
require('../common/Portal.js');
require('react-dom');
require('../loading/gradient.js');
require('../loading/plugin.js');
require('../input/Input.js');
require('../_chunks/dep-1bafebb1.js');
require('../_chunks/dep-735b841a.js');
require('../_util/forwardRefWithStatics.js');
require('hoist-non-react-statics');
require('../input/InputGroup.js');
require('../_util/useDefaultValue.js');
require('../_util/useDefault.js');

function _interopDefaultLegacy (e) { return e && typeof e === 'object' && 'default' in e ? e : { 'default': e }; }

var React__default = /*#__PURE__*/_interopDefaultLegacy(React);
var classNames__default = /*#__PURE__*/_interopDefaultLegacy(classNames);

var _excluded = ["className", "style", "defaultValue", "value", "disabled", "size", "theme", "step", "max", "min", "decimalPlaces", "format", "onChange", "onBlur", "onFocus", "onEnter", "onKeydown", "onKeyup", "onKeypress"],
    _excluded2 = ["value"];

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { defineProperty._defineProperty(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }
var InputNumber = /*#__PURE__*/React.forwardRef(function (props, ref) {
  var _classNames;

  var className = props.className,
      style = props.style,
      defaultValue = props.defaultValue,
      value = props.value,
      _props$disabled = props.disabled,
      disabled = _props$disabled === void 0 ? false : _props$disabled,
      _props$size = props.size,
      size = _props$size === void 0 ? "medium" : _props$size,
      _props$theme = props.theme,
      theme = _props$theme === void 0 ? "row" : _props$theme,
      _props$step = props.step,
      step = _props$step === void 0 ? 1 : _props$step,
      _props$max = props.max,
      max = _props$max === void 0 ? Number.MAX_SAFE_INTEGER : _props$max,
      _props$min = props.min,
      min = _props$min === void 0 ? Number.MIN_SAFE_INTEGER : _props$min,
      decimalPlaces = props.decimalPlaces,
      format = props.format,
      onChange = props.onChange,
      onBlur = props.onBlur,
      onFocus = props.onFocus,
      onEnter = props.onEnter,
      onKeydown = props.onKeydown,
      onKeyup = props.onKeyup,
      onKeypress = props.onKeypress,
      restInputProps = objectWithoutProperties._objectWithoutProperties(props, _excluded);

  var _useConfig = _util_useConfig["default"](),
      classPrefix = _useConfig.classPrefix;

  var commonClassNames = _util_useCommonClassName["default"]();
  var componentType = "input-number";
  var inputClassName = "".concat(classPrefix, "-").concat(componentType);

  var getRangeValue = function getRangeValue(value2) {
    if (value2 < min) return min;
    if (value2 > max) return max;
    return value2;
  };

  var _useState = React.useState(function () {
    var initialValue = "";

    if (!inputNumber_utils_numberUtils.isInvalidNumber(defaultValue)) {
      initialValue = getRangeValue(Number(defaultValue));
    }

    if (!inputNumber_utils_numberUtils.isInvalidNumber(value)) {
      initialValue = value;
    }

    if (format && initialValue !== "") {
      return format(getRangeValue(Number(initialValue))) || "";
    }

    return initialValue;
  }),
      _useState2 = slicedToArray._slicedToArray(_useState, 2),
      internalInputValue = _useState2[0],
      setInternalInputValue = _useState2[1];

  var decimalValue = internalInputValue;

  if (typeof internalInputValue === "string") {
    decimalValue = inputNumber_utils_numberUtils.strToNumber(internalInputValue) || 0;
  }

  var setInputValue = function setInputValue(inputStr) {
    var _format;

    if (["", void 0].includes(inputStr)) {
      return setInternalInputValue("");
    }

    var formattedInputValue = (_format = format === null || format === void 0 ? void 0 : format(Number(inputStr))) !== null && _format !== void 0 ? _format : inputStr;
    setInternalInputValue(formattedInputValue);
  };

  var _useState3 = React.useState(false),
      _useState4 = slicedToArray._slicedToArray(_useState3, 2),
      isError = _useState4[0],
      setError = _useState4[1];

  var disabledDecrease = disabled || isError || decimalValue - step < min;
  var disabledIncrease = disabled || isError || decimalValue + step > max;

  var isOutOfRange = function isOutOfRange(number) {
    return number > max || number < min;
  };

  var checkInput = function checkInput(inputStr) {
    if (inputStr === "") {
      setError(false);
      return true;
    }

    var hasError = inputNumber_utils_numberUtils.isInvalidNumber(inputStr) || isOutOfRange(Number(inputStr));
    setError(hasError);
    return !hasError;
  };

  var stepPrecision = React.useMemo(function () {
    return inputNumber_utils_numberUtils.getNumberPrecision(step);
  }, [step]);
  var getPrecision = React.useCallback(function (str) {
    var numberPrecision = inputNumber_utils_numberUtils.getNumberPrecision(str);
    return decimalPlaces !== null && decimalPlaces !== void 0 ? decimalPlaces : Math.max(numberPrecision, stepPrecision);
  }, [stepPrecision, decimalPlaces]);
  React.useEffect(function () {
    if (value !== void 0) {
      checkInput(value);
    }
  }, [value]);
  _util_useUpdateEffect["default"](function () {
    setInputValue((value !== null && value !== void 0 ? value : "").toString());
  }, [value]);

  var triggerValueUpdate = function triggerValueUpdate(action) {
    var value2 = action.value,
        context = objectWithoutProperties._objectWithoutProperties(action, _excluded2);

    if (!disabled) {
      onChange === null || onChange === void 0 ? void 0 : onChange(value2, context);
    }
  };

  var onInternalInput = function onInternalInput(inputStr, _ref) {
    var e = _ref.e;

    if (inputStr === "") {
      setInputValue(inputStr);
      return triggerValueUpdate({
        type: "input",
        value: void 0,
        e: e
      });
    }

    var filteredInputStr = inputNumber_utils_numberUtils.strToNumber(inputStr);

    if (Number.isNaN(filteredInputStr)) {
      setInternalInputValue(inputStr);
      if (!checkInput(inputStr)) return;
    }

    setInputValue(filteredInputStr.toString());
    if (!checkInput(filteredInputStr)) return;
    triggerValueUpdate({
      type: "input",
      value: filteredInputStr,
      e: e
    });
  };

  var onInternalStep = function onInternalStep(action) {
    var type = action.type,
        e = action.e;
    var currentValue = decimalValue || 0;
    var precision = getPrecision(currentValue);
    var updateValue;

    switch (type) {
      case "add":
        {
          updateValue = Number((currentValue + step).toFixed(precision));
          break;
        }

      case "reduce":
        {
          updateValue = Number((currentValue - step).toFixed(precision));
          break;
        }
    }

    setInputValue(updateValue);
    triggerValueUpdate({
      value: updateValue,
      type: type,
      e: e
    });
    e.preventDefault();
  };

  var handleBlur = function handleBlur(e) {
    var _updateValue;

    var updateValue;
    var internalFloatValue = parseFloat(internalInputValue);

    if (internalInputValue === "") {
      updateValue = void 0;
    } else if (!Number.isNaN(internalFloatValue)) {
      updateValue = getRangeValue(internalFloatValue);
    } else {
      var checkVal = internalInputValue.replace(/[^0-9]/gi, "");
      updateValue = checkVal;

      if (!checkVal) {
        updateValue = value;
      }
    }

    onBlur === null || onBlur === void 0 ? void 0 : onBlur(updateValue, {
      e: e
    });
    setInputValue(((_updateValue = updateValue) !== null && _updateValue !== void 0 ? _updateValue : "").toString());
    setError(false);

    if (updateValue !== value) {
      triggerValueUpdate({
        value: updateValue,
        e: e,
        type: ""
      });
    }
  };

  var handleFocus = function handleFocus(e) {
    return onFocus === null || onFocus === void 0 ? void 0 : onFocus(decimalValue, {
      e: e
    });
  };

  var handleKeydownEnter = function handleKeydownEnter(e) {
    e.key === "Enter" && (onEnter === null || onEnter === void 0 ? void 0 : onEnter(decimalValue, {
      e: e
    }));
  };

  var handleKeydown = function handleKeydown(e) {
    onKeydown === null || onKeydown === void 0 ? void 0 : onKeydown(decimalValue, {
      e: e
    });
    handleKeydownEnter(e);
  };

  var handleKeyup = function handleKeyup(e) {
    return onKeyup === null || onKeyup === void 0 ? void 0 : onKeyup(decimalValue, {
      e: e
    });
  };

  var handleKeypress = function handleKeypress(e) {
    return onKeypress === null || onKeypress === void 0 ? void 0 : onKeypress(decimalValue, {
      e: e
    });
  };

  return /* @__PURE__ */React__default["default"].createElement("div", {
    ref: ref,
    className: classNames__default["default"](className, inputClassName, commonClassNames.SIZE[size], (_classNames = {}, defineProperty._defineProperty(_classNames, commonClassNames.STATUS.disabled, disabled), defineProperty._defineProperty(_classNames, "".concat(classPrefix, "-is-controls-right"), theme === "column"), defineProperty._defineProperty(_classNames, "".concat(inputClassName, "--").concat(theme), theme), _classNames)),
    style: style,
    onBlur: handleBlur,
    onFocus: handleFocus,
    onKeyDown: handleKeydown,
    onKeyUp: handleKeyup,
    onKeyPress: handleKeypress
  }, theme !== "normal" && /* @__PURE__ */React__default["default"].createElement(inputNumber_StepHandler["default"], {
    prefixClassName: inputClassName,
    theme: theme,
    disabledDecrease: disabledDecrease,
    disabledIncrease: disabledIncrease,
    onStep: onInternalStep
  }), /* @__PURE__ */React__default["default"].createElement(input_index.Input, _objectSpread({
    disabled: disabled,
    value: internalInputValue,
    onChange: onInternalInput,
    status: isError ? "error" : void 0
  }, restInputProps)));
});
InputNumber.displayName = "InputNumber";

exports["default"] = InputNumber;
//# sourceMappingURL=InputNumber.js.map
