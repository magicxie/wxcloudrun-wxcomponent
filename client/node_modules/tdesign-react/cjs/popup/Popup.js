/**
 * tdesign v0.22.1
 * (c) 2022 tdesign
 * @license MIT
 */

'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var defineProperty = require('../_chunks/dep-449daca3.js');
var slicedToArray = require('../_chunks/dep-fa36e79f.js');
var React = require('react');
var reactTransitionGroup = require('react-transition-group');
var classNames = require('classnames');
var reactPopper = require('react-popper');
var _util_useDefault = require('../_util/useDefault.js');
var _util_useConfig = require('../_util/useConfig.js');
var _util_composeRefs = require('../_util/composeRefs.js');
var _util_usePrevious = require('../_util/usePrevious.js');
var popup_Portal = require('./Portal.js');
var popup_hooks_useTriggerProps = require('./hooks/useTriggerProps.js');
var popup_hooks_usePopupCssTransition = require('./hooks/usePopupCssTransition.js');
require('../_chunks/dep-045b87c1.js');
require('../_util/noop.js');
require('../config-provider/ConfigContext.js');
require('../locale/zh_CN.js');
require('react-dom');
require('../_util/useClickOutside.js');

function _interopDefaultLegacy (e) { return e && typeof e === 'object' && 'default' in e ? e : { 'default': e }; }

var React__default = /*#__PURE__*/_interopDefaultLegacy(React);
var classNames__default = /*#__PURE__*/_interopDefaultLegacy(classNames);

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { defineProperty._defineProperty(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }
var placementMap = {
  top: "top",
  "top-left": "top-start",
  "top-right": "top-end",
  bottom: "bottom",
  "bottom-left": "bottom-start",
  "bottom-right": "bottom-end",
  left: "left",
  "left-top": "left-start",
  "left-bottom": "left-end",
  right: "right",
  "right-top": "right-start",
  "right-bottom": "right-end"
};
var Popup = /*#__PURE__*/React.forwardRef(function (props, ref) {
  var _props$trigger = props.trigger,
      trigger = _props$trigger === void 0 ? "hover" : _props$trigger,
      _props$content = props.content,
      content = _props$content === void 0 ? null : _props$content,
      _props$placement = props.placement,
      placement = _props$placement === void 0 ? "top" : _props$placement,
      _props$attach = props.attach,
      attach = _props$attach === void 0 ? "body" : _props$attach,
      _props$showArrow = props.showArrow,
      showArrow = _props$showArrow === void 0 ? false : _props$showArrow,
      _props$destroyOnClose = props.destroyOnClose,
      destroyOnClose = _props$destroyOnClose === void 0 ? false : _props$destroyOnClose,
      className = props.className,
      style = props.style,
      overlayClassName = props.overlayClassName,
      overlayStyle = props.overlayStyle,
      triggerElement = props.triggerElement,
      _props$children = props.children,
      children = _props$children === void 0 ? triggerElement : _props$children,
      disabled = props.disabled,
      _props$defaultVisible = props.defaultVisible,
      defaultVisible = _props$defaultVisible === void 0 ? false : _props$defaultVisible,
      zIndex = props.zIndex,
      onVisibleChange = props.onVisibleChange,
      expandAnimation = props.expandAnimation;

  var _useConfig = _util_useConfig["default"](),
      classPrefix = _useConfig.classPrefix;

  var _useDefault = _util_useDefault["default"](props.visible, defaultVisible, onVisibleChange),
      _useDefault2 = slicedToArray._slicedToArray(_useDefault, 2),
      visible = _useDefault2[0],
      setVisible = _useDefault2[1];

  var preVisible = _util_usePrevious["default"](visible);

  var _useState = React.useState(null),
      _useState2 = slicedToArray._slicedToArray(_useState, 2),
      triggerRef = _useState2[0],
      setTriggerRef = _useState2[1];

  var _useState3 = React.useState(null),
      _useState4 = slicedToArray._slicedToArray(_useState3, 2),
      overlayRef = _useState4[0],
      setOverlayRef = _useState4[1];

  var contentRef = React.useRef(null);

  var _useState5 = React.useState(false),
      _useState6 = slicedToArray._slicedToArray(_useState5, 2),
      firstUpdate = _useState6[0],
      setFirstUpdate = _useState6[1];

  var onPopperFirstUpdate = React.useMemo(function () {
    return function () {
      setFirstUpdate(true);
    };
  }, []);
  var popperOptions = React.useMemo(function () {
    var _contentRef$current, _childElement$offsetH, _childElement$offsetW;

    if (!visible) return {
      padding: 0
    };
    var childElement = (_contentRef$current = contentRef.current) === null || _contentRef$current === void 0 ? void 0 : _contentRef$current.firstElementChild;
    var height = (_childElement$offsetH = childElement === null || childElement === void 0 ? void 0 : childElement.offsetHeight) !== null && _childElement$offsetH !== void 0 ? _childElement$offsetH : 0;
    var width = (_childElement$offsetW = childElement === null || childElement === void 0 ? void 0 : childElement.offsetWidth) !== null && _childElement$offsetW !== void 0 ? _childElement$offsetW : 0;
    return {
      padding: {
        top: height,
        left: width,
        right: width,
        bottom: height
      }
    };
  }, [visible, overlayRef]);

  var _usePopper = reactPopper.usePopper(triggerRef, overlayRef, {
    placement: placementMap[placement],
    onFirstUpdate: onPopperFirstUpdate,
    modifiers: [{
      name: "flip",
      options: _objectSpread({}, popperOptions)
    }]
  }),
      styles = _usePopper.styles,
      attributes = _usePopper.attributes,
      update = _usePopper.update;

  var defaultStyles = React.useMemo(function () {
    if (triggerRef && typeof overlayStyle === "function") return _objectSpread(_objectSpread({}, overlayStyle(triggerRef)), {}, {
      zIndex: zIndex
    });
    return _objectSpread(_objectSpread({}, overlayStyle), {}, {
      zIndex: zIndex
    });
  }, [overlayStyle, zIndex, triggerRef]);
  var overlayVisibleStyle = defaultStyles;
  var triggerNodeTemp = React.useMemo(function () {
    var _React$Children$toArr = React__default["default"].Children.toArray(children),
        _React$Children$toArr2 = slicedToArray._slicedToArray(_React$Children$toArr, 1),
        triggerChildNode = _React$Children$toArr2[0];

    if (React__default["default"].Children.count(children) === 1 && /*#__PURE__*/React.isValidElement(triggerChildNode)) {
      return triggerChildNode;
    }

    return /* @__PURE__ */React__default["default"].createElement("span", {
      className: "".concat(classPrefix, "-trigger")
    }, children);
  }, [children, classPrefix]);

  var _useTriggerProps = popup_hooks_useTriggerProps["default"]({
    current: overlayRef
  }, {
    current: triggerRef
  }, [trigger], visible, setVisible, disabled, triggerNodeTemp),
      _useTriggerProps2 = slicedToArray._slicedToArray(_useTriggerProps, 2),
      triggerProps = _useTriggerProps2[0],
      popupProps = _useTriggerProps2[1];

  var disabledClassName = classNames__default["default"](defineProperty._defineProperty({}, "".concat(classPrefix, "-is-disabled"), disabled));
  var triggerNode = /*#__PURE__*/React.cloneElement(triggerNodeTemp, _objectSpread({
    ref: _util_composeRefs["default"](triggerNodeTemp.ref, setTriggerRef),
    className: classNames__default["default"](disabledClassName, triggerNodeTemp.props.className)
  }, triggerProps));
  var cssTransitionState = popup_hooks_usePopupCssTransition["default"]({
    contentRef: contentRef,
    classPrefix: classPrefix,
    expandAnimation: expandAnimation
  });
  React.useEffect(function () {
    if ((visible || firstUpdate) && update) {
      update();
    }
  }, [visible, preVisible, update, children, firstUpdate]);

  var handlePopupWrapperMouseDown = function handlePopupWrapperMouseDown() {
    var removeUpdate = function removeUpdate() {
      return window.removeEventListener("mousemove", update);
    };

    window.removeEventListener("mouseup", removeUpdate);
    window.addEventListener("mousemove", update);
    window.addEventListener("mouseup", removeUpdate);
  };

  var portal = visible || overlayRef ? /* @__PURE__ */React__default["default"].createElement(popup_Portal["default"], {
    attach: attach
  }, /* @__PURE__ */React__default["default"].createElement(reactTransitionGroup.CSSTransition, _objectSpread({
    "in": visible,
    appear: true,
    unmountOnExit: destroyOnClose
  }, cssTransitionState.props), /* @__PURE__ */React__default["default"].createElement("div", _objectSpread(_objectSpread({
    ref: _util_composeRefs["default"](setOverlayRef, ref),
    style: styles.popper,
    className: "".concat(classPrefix, "-popup")
  }, attributes.popper), popupProps), /* @__PURE__ */React__default["default"].createElement("div", {
    className: classNames__default["default"]("".concat(classPrefix, "-popup__content"), overlayClassName, defineProperty._defineProperty({}, "".concat(classPrefix, "-popup__content--arrow"), showArrow)),
    style: overlayVisibleStyle,
    ref: contentRef
  }, showArrow ? /* @__PURE__ */React__default["default"].createElement("div", {
    style: styles.arrow,
    className: "".concat(classPrefix, "-popup__arrow")
  }) : null, content)))) : null;
  return /* @__PURE__ */React__default["default"].createElement("div", {
    className: classNames__default["default"]("".concat(classPrefix, "-popup__reference"), className),
    onMouseDown: handlePopupWrapperMouseDown,
    style: style
  }, triggerNode, portal);
});
Popup.displayName = "Popup";

exports["default"] = Popup;
//# sourceMappingURL=Popup.js.map
