/**
 * tdesign v0.22.1
 * (c) 2022 tdesign
 * @license MIT
 */

'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var defineProperty = require('../../_chunks/dep-449daca3.js');
var slicedToArray = require('../../_chunks/dep-fa36e79f.js');
var React = require('react');
var classNames = require('classnames');
var dayjs = require('dayjs');
var debounce = require('../../_chunks/dep-228a3548.js');
var padStart = require('../../_chunks/dep-99d6d655.js');
var _isIterateeCall = require('../../_chunks/dep-059e74d9.js');
var toInteger = require('../../_chunks/dep-5e46865d.js');
var _util_useConfig = require('../../_util/useConfig.js');
var _util_noop = require('../../_util/noop.js');
var timePicker_interfaces = require('../interfaces.js');
var timePicker_consts = require('../consts.js');
require('../../_chunks/dep-045b87c1.js');
require('../../_chunks/dep-735b841a.js');
require('../../_chunks/dep-a7666a95.js');
require('../../_chunks/dep-0e3f1753.js');
require('../../_chunks/dep-8bb9b7ba.js');
require('../../_chunks/dep-9c74d22d.js');
require('../../_chunks/dep-48870ae5.js');
require('../../_chunks/dep-7a0cfc4c.js');
require('../../_chunks/dep-9125a75e.js');
require('../../_chunks/dep-bc486aab.js');
require('../../_chunks/dep-c7adf4af.js');
require('../../_chunks/dep-942a7aba.js');
require('../../_chunks/dep-6681bc7b.js');
require('../../_chunks/dep-f445e9bb.js');
require('../../_chunks/dep-1bafebb1.js');
require('../../_chunks/dep-72511bfe.js');
require('../../_chunks/dep-7d00ab60.js');
require('../../config-provider/ConfigContext.js');
require('../../locale/zh_CN.js');
require('../../locale/LocalReceiver.js');

function _interopDefaultLegacy (e) { return e && typeof e === 'object' && 'default' in e ? e : { 'default': e }; }

var React__default = /*#__PURE__*/_interopDefaultLegacy(React);
var classNames__default = /*#__PURE__*/_interopDefaultLegacy(classNames);
var dayjs__default = /*#__PURE__*/_interopDefaultLegacy(dayjs);

/* Built-in method references for those with the same name as other `lodash` methods. */
var nativeCeil = Math.ceil,
    nativeMax = Math.max;
/**
 * The base implementation of `_.range` and `_.rangeRight` which doesn't
 * coerce arguments.
 *
 * @private
 * @param {number} start The start of the range.
 * @param {number} end The end of the range.
 * @param {number} step The value to increment or decrement by.
 * @param {boolean} [fromRight] Specify iterating from right to left.
 * @returns {Array} Returns the range of numbers.
 */

function baseRange$1(start, end, step, fromRight) {
  var index = -1,
      length = nativeMax(nativeCeil((end - start) / (step || 1)), 0),
      result = Array(length);

  while (length--) {
    result[fromRight ? length : ++index] = start;
    start += step;
  }

  return result;
}

var _baseRange = baseRange$1;

var baseRange = _baseRange,
    isIterateeCall = _isIterateeCall._isIterateeCall,
    toFinite = toInteger.toFinite_1;
/**
 * Creates a `_.range` or `_.rangeRight` function.
 *
 * @private
 * @param {boolean} [fromRight] Specify iterating from right to left.
 * @returns {Function} Returns the new range function.
 */

function createRange$1(fromRight) {
  return function (start, end, step) {
    if (step && typeof step != 'number' && isIterateeCall(start, end, step)) {
      end = step = undefined;
    } // Ensure the sign of `-0` is preserved.


    start = toFinite(start);

    if (end === undefined) {
      end = start;
      start = 0;
    } else {
      end = toFinite(end);
    }

    step = step === undefined ? start < end ? 1 : -1 : toFinite(step);
    return baseRange(start, end, step, fromRight);
  };
}

var _createRange = createRange$1;

var createRange = _createRange;
/**
 * Creates an array of numbers (positive and/or negative) progressing from
 * `start` up to, but not including, `end`. A step of `-1` is used if a negative
 * `start` is specified without an `end` or `step`. If `end` is not specified,
 * it's set to `start` with `start` then set to `0`.
 *
 * **Note:** JavaScript follows the IEEE-754 standard for resolving
 * floating-point values which can produce unexpected results.
 *
 * @static
 * @since 0.1.0
 * @memberOf _
 * @category Util
 * @param {number} [start=0] The start of the range.
 * @param {number} end The end of the range.
 * @param {number} [step=1] The value to increment or decrement by.
 * @returns {Array} Returns the range of numbers.
 * @see _.inRange, _.rangeRight
 * @example
 *
 * _.range(4);
 * // => [0, 1, 2, 3]
 *
 * _.range(-4);
 * // => [0, -1, -2, -3]
 *
 * _.range(1, 5);
 * // => [1, 2, 3, 4]
 *
 * _.range(0, 20, 5);
 * // => [0, 5, 10, 15]
 *
 * _.range(0, -4, -1);
 * // => [0, -1, -2, -3]
 *
 * _.range(1, 4, 0);
 * // => [1, 1, 1]
 *
 * _.range(0);
 * // => []
 */

var range = createRange();
var range_1 = range;

var timeArr = [timePicker_interfaces.EPickerCols.hour, timePicker_interfaces.EPickerCols.minute, timePicker_interfaces.EPickerCols.second];

var SinglePanel = function SinglePanel(props) {
  var steps = props.steps,
      format = props.format,
      _props$onChange = props.onChange,
      onChange = _props$onChange === void 0 ? _util_noop["default"] : _props$onChange,
      value = props.value,
      _props$hideDisabledTi = props.hideDisabledTime,
      hideDisabledTime = _props$hideDisabledTi === void 0 ? true : _props$hideDisabledTi,
      disableTime = props.disableTime;

  var _useConfig = _util_useConfig["default"](),
      classPrefix = _useConfig.classPrefix;

  var TEXT_CONFIG = timePicker_consts.useTimePickerTextConfig();
  var panelClassName = "".concat(classPrefix, "-time-picker__panel");

  var _useState = React.useState([]),
      _useState2 = slicedToArray._slicedToArray(_useState, 2),
      cols = _useState2[0],
      setCols = _useState2[1];

  var colsRef = React.useRef([]);
  var maskRef = React.useRef(null);
  var dayjsValue = React.useMemo(function () {
    var isStepsSet = !!steps.filter(function (v) {
      return v > 1;
    }).length;

    if (value) {
      return dayjs__default["default"](value, format);
    }

    if (isStepsSet) {
      return dayjs__default["default"]().hour(0).minute(0).second(0);
    }

    return dayjs__default["default"]();
  }, [value, format, steps]);
  React.useEffect(function () {
    colsRef.current = colsRef.current.slice(0, cols.length);
  }, [cols]);
  React.useEffect(function () {
    var match = format.match(/(a\s+|A\s+)?(h+|H+)?:?(m+)?:?(s+)?(\s+a|\s+A)?/);

    var _match = slicedToArray._slicedToArray(match, 6),
        startCol = _match[1],
        hourCol = _match[2],
        minuteCol = _match[3],
        secondCol = _match[4],
        endCol = _match[5];

    var meridiem = timePicker_interfaces.EPickerCols.meridiem,
        hour = timePicker_interfaces.EPickerCols.hour,
        minute = timePicker_interfaces.EPickerCols.minute,
        second = timePicker_interfaces.EPickerCols.second;
    var renderCol = [startCol && meridiem, hourCol && hour, minuteCol && minute, secondCol && second, endCol && meridiem].filter(function (v) {
      return !!v;
    });
    setCols(renderCol);
  }, [format]);
  var getItemHeight = React.useCallback(function () {
    var _maskRef$current;

    var maskDom = maskRef === null || maskRef === void 0 ? void 0 : (_maskRef$current = maskRef.current) === null || _maskRef$current === void 0 ? void 0 : _maskRef$current.querySelector("div");
    var timeItemTotalHeight = maskDom.offsetHeight + parseInt(getComputedStyle(maskDom).marginTop, 10);
    return timeItemTotalHeight;
  }, []);

  var closestLookup = function closestLookup(availableArr, calcVal, step) {
    if (step <= 1) return calcVal;
    return availableArr.sort(function (a, b) {
      return Math.abs(calcVal + 1 - a) - Math.abs(calcVal + 1 - b);
    })[0];
  };

  var timeItemCanUsed = function timeItemCanUsed(col, el) {
    var colIdx = timeArr.indexOf(col);

    if (colIdx !== -1) {
      var params = [dayjsValue.hour(), dayjsValue.minute(), dayjsValue.second()];
      params[colIdx] = el;
      return !(disableTime && disableTime !== null && disableTime !== void 0 && disableTime.apply(void 0, params));
    }

    return true;
  };

  var getColList = React.useCallback(function (col) {
    var count = 0;

    if (timeArr.includes(col)) {
      var colIdx = timeArr.indexOf(col);
      var colStep = steps[colIdx];

      if (col === timePicker_interfaces.EPickerCols.hour) {
        count = /[h]{1}/.test(format) ? 11 : 23;
      } else {
        count = 59;
      }

      var colList = range_1(0, count + 1, Number(colStep)).map(function (v) {
        return padStart.padStart_1(String(v), 2, "0");
      }) || [];
      return hideDisabledTime && !!disableTime ? colList.filter(function (t) {
        var params = [dayjsValue.hour(), dayjsValue.minute(), dayjsValue.second()];
        params[colIdx] = Number(t);
        return !(disableTime !== null && disableTime !== void 0 && disableTime.apply(void 0, params));
      }) : colList;
    }

    return timePicker_consts.MERIDIEM_LIST;
  }, [steps, format, hideDisabledTime, dayjsValue, disableTime]);
  var getScrollDistance = React.useCallback(function (col, time) {
    if (col === timePicker_interfaces.EPickerCols.hour && /[h]{1}/.test(format)) {
      time %= 12;
    }

    var itemIdx = getColList(col).indexOf(padStart.padStart_1(String(time), 2, "0"));
    var timeItemTotalHeight = getItemHeight();
    var distance = Math.abs(itemIdx * timeItemTotalHeight + timeItemTotalHeight / 2);
    return distance;
  }, [getItemHeight, getColList, format]);

  var handleScroll = function handleScroll(col, idx, e) {
    var _colsRef$current$idx;

    var val;
    var isScrollUp = e.deltaY < 0;
    var scrollTop = (_colsRef$current$idx = colsRef.current[idx]) === null || _colsRef$current$idx === void 0 ? void 0 : _colsRef$current$idx.scrollTop;
    var colStep = Math.abs(Math.round(scrollTop / getItemHeight() - (isScrollUp && scrollTop >= 1 ? 1 : 0)));

    if (timeArr.includes(col)) {
      var _dayjsValue$col;

      var max = 59;

      if (col === timePicker_interfaces.EPickerCols.hour) {
        max = /[h]{1}/.test(format) ? 11 : 23;
      }

      var colIdx = timeArr.indexOf(col);
      var availableArr = range_1(0, max + 1, Number(steps[colIdx]));
      val = closestLookup(availableArr, Number(getColList(col)[Math.min(colStep, max, availableArr.length - 1)]), Number(steps[colIdx]));

      if (col === timePicker_interfaces.EPickerCols.hour && cols.includes(timePicker_interfaces.EPickerCols.meridiem) && dayjsValue.hour() > 12) {
        val = Number(val) + 12;
      }

      if (timeItemCanUsed(col, val)) onChange((_dayjsValue$col = dayjsValue[col]) === null || _dayjsValue$col === void 0 ? void 0 : _dayjsValue$col.call(dayjsValue, val).format(format));
    } else {
      var meridiem = timePicker_consts.MERIDIEM_LIST[Math.min(colStep, 1)].toLowerCase();
      val = meridiem;
      var currentHour = dayjsValue.hour();

      if (meridiem === timePicker_consts.AM && currentHour >= 12) {
        onChange(dayjsValue.hour(currentHour - 12).format(format));
      } else if (meridiem === timePicker_consts.PM && currentHour < 12) {
        onChange(dayjsValue.hour(currentHour + 12).format(format));
      }
    }

    var distance = getScrollDistance(col, val);

    if (distance !== scrollTop) {
      var scroller = colsRef.current[cols.indexOf(col)];
      if (!distance || !scroller || scroller.scrollTop === distance) return;
      scroller.scrollTo({
        top: distance,
        behavior: "smooth"
      });
    }
  };

  var scrollToTime = React.useCallback(function (col, time, idx) {
    var behavior = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : "auto";
    var distance = getScrollDistance(col, time);
    var scroller = colsRef.current[idx];
    if (!distance || !scroller || scroller.scrollTop === distance) return;
    scroller.scrollTo({
      top: distance,
      behavior: behavior
    });
  }, [getScrollDistance]);

  var handleTimeItemClick = function handleTimeItemClick(col, el) {
    if (timeArr.includes(col)) {
      var _dayjsValue$col2, _dayjsValue$col3;

      if (col === timePicker_interfaces.EPickerCols.hour && dayjsValue.format("a") === timePicker_consts.PM && cols.includes(timePicker_interfaces.EPickerCols.meridiem)) {
        el = Number(el) + 12;
      }

      value ? onChange((_dayjsValue$col2 = dayjsValue[col]) === null || _dayjsValue$col2 === void 0 ? void 0 : _dayjsValue$col2.call(dayjsValue, el).format(format)) : onChange((_dayjsValue$col3 = dayjsValue[col]) === null || _dayjsValue$col3 === void 0 ? void 0 : _dayjsValue$col3.call(dayjsValue, el).format(format));
    } else {
      var currentHour = dayjsValue.hour();

      if (el === timePicker_consts.AM && currentHour >= 12) {
        onChange(dayjsValue.hour(currentHour - 12).format(format));
      } else if (el === timePicker_consts.PM && currentHour < 12) {
        onChange(dayjsValue.hour(currentHour + 12).format(format));
      }
    }
  };

  var updateTimeScrollPos = React.useCallback(function () {
    var behavior = value ? "smooth" : "auto";
    var isStepsSet = !!steps.filter(function (v) {
      return v > 1;
    }).length;
    cols.forEach(function (col, idx) {
      if (!isStepsSet || isStepsSet && value) {
        var _dayjsValue$col4;

        scrollToTime(col, timeArr.includes(col) ? (_dayjsValue$col4 = dayjsValue[col]) === null || _dayjsValue$col4 === void 0 ? void 0 : _dayjsValue$col4.call(dayjsValue) : dayjsValue.format("a"), idx, behavior);
      } else {
        var _getColList;

        scrollToTime(col, (_getColList = getColList(col)) === null || _getColList === void 0 ? void 0 : _getColList[0], idx, behavior);
      }
    });
  }, [cols, scrollToTime, dayjsValue, value, steps, getColList]);
  React.useEffect(function () {
    updateTimeScrollPos();
  });
  var isCurrent = React.useCallback(function (col, colItem) {
    var _dayjsValue$col5;

    var colVal;

    if (col === timePicker_interfaces.EPickerCols.meridiem) {
      var currentMeridiem = dayjsValue.format("a");
      return currentMeridiem === colItem;
    }

    colVal = (_dayjsValue$col5 = dayjsValue[col]) === null || _dayjsValue$col5 === void 0 ? void 0 : _dayjsValue$col5.call(dayjsValue);

    if (col === timePicker_interfaces.EPickerCols.hour && /[h]{1}/.test(format)) {
      colVal %= 12;
    }

    return colVal === Number(colItem);
  }, [format, dayjsValue]);

  function renderScrollers() {
    return cols.map(function (col, idx) {
      return /* @__PURE__ */React__default["default"].createElement("ul", {
        key: "".concat(col, "_").concat(idx),
        ref: function ref(el) {
          return colsRef.current[idx] = el;
        },
        className: "".concat(panelClassName, "-body-scroll"),
        onWheel: debounce.debounce_1(function (e) {
          return handleScroll(col, idx, e);
        }, 50)
      }, getColList(col).map(function (el) {
        var _classNames;

        return /* @__PURE__ */React__default["default"].createElement("li", {
          key: el,
          className: classNames__default["default"]("".concat(panelClassName, "-body-scroll-item"), (_classNames = {}, defineProperty._defineProperty(_classNames, "".concat(classPrefix, "-is-disabled"), !timeItemCanUsed(col, el)), defineProperty._defineProperty(_classNames, "".concat(classPrefix, "-is-current"), isCurrent(col, el)), _classNames)),
          onClick: function onClick() {
            return handleTimeItemClick(col, el);
          }
        }, timeArr.includes(col) ? el : TEXT_CONFIG[el]);
      }));
    });
  }

  return /* @__PURE__ */React__default["default"].createElement("div", {
    className: "".concat(panelClassName, "-body")
  }, /* @__PURE__ */React__default["default"].createElement("div", {
    className: "".concat(panelClassName, "-body-active-mask"),
    ref: maskRef
  }, cols.map(function (col, idx) {
    return /* @__PURE__ */React__default["default"].createElement("div", {
      key: "".concat(col, "_").concat(idx)
    });
  })), renderScrollers());
};

exports["default"] = SinglePanel;
//# sourceMappingURL=SinglePanel.js.map
