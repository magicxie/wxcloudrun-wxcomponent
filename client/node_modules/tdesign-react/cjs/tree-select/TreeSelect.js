/**
 * tdesign v0.22.1
 * (c) 2022 tdesign
 * @license MIT
 */

'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var defineProperty = require('../_chunks/dep-449daca3.js');
var slicedToArray = require('../_chunks/dep-fa36e79f.js');
var React = require('react');
var isArray = require('../_chunks/dep-9125a75e.js');
var isEmpty = require('../_chunks/dep-72f8673c.js');
var _baseGetTag = require('../_chunks/dep-0e3f1753.js');
var isObjectLike$1 = require('../_chunks/dep-48870ae5.js');
var isFunction = require('../_chunks/dep-1bafebb1.js');
var locale_LocalReceiver = require('../locale/LocalReceiver.js');
var _util_useConfig = require('../_util/useConfig.js');
var _util_useDefault = require('../_util/useDefault.js');
var popup_index = require('../popup/index.js');
var tree_index = require('../tree/index.js');
var _common_js_tree_treeStore = require('../_common/js/tree/tree-store.js');
var treeSelect_TreeSelectTags = require('./TreeSelectTags.js');
var treeSelect_TreeSelectInput = require('./TreeSelectInput.js');
var treeSelect_TreeSelectSuffix = require('./TreeSelectSuffix.js');
var treeSelect_useTreeSelectConfig = require('./useTreeSelectConfig.js');
require('../_chunks/dep-045b87c1.js');
require('../_chunks/dep-c82d4aac.js');
require('../_chunks/dep-72511bfe.js');
require('../_chunks/dep-07d4a79b.js');
require('../_chunks/dep-fb89215e.js');
require('../_chunks/dep-69abf228.js');
require('../_chunks/dep-20e76bfc.js');
require('../_chunks/dep-735b841a.js');
require('../_chunks/dep-a7666a95.js');
require('../_chunks/dep-c5449fbe.js');
require('../_chunks/dep-f445e9bb.js');
require('../config-provider/ConfigContext.js');
require('../locale/zh_CN.js');
require('../_util/noop.js');
require('../popup/Popup.js');
require('react-transition-group');
require('classnames');
require('react-popper');
require('../_util/composeRefs.js');
require('../_util/usePrevious.js');
require('../popup/Portal.js');
require('react-dom');
require('../popup/hooks/useTriggerProps.js');
require('../_util/useClickOutside.js');
require('../popup/hooks/usePopupCssTransition.js');
require('../tree/Tree.js');
require('../_util/usePersistFn.js');
require('../tree/useTreeConfig.js');
require('../tree/useControllable.js');
require('../tree/TreeItem.js');
require('tdesign-icons-react');
require('../loading/index.js');
require('../loading/loading.js');
require('../_util/dom.js');
require('raf');
require('../_chunks/dep-0705da20.js');
require('../_util/easing.js');
require('../common/Portal.js');
require('../loading/gradient.js');
require('../loading/plugin.js');
require('../_util/useRipple.js');
require('../_util/setStyle.js');
require('../checkbox/index.js');
require('../_chunks/dep-8027cfc6.js');
require('../_util/forwardRefWithStatics.js');
require('hoist-non-react-statics');
require('../common/Check.js');
require('../_chunks/dep-e03ca79d.js');
require('../_util/helper.js');
require('../_chunks/dep-3ca698ba.js');
require('../_chunks/dep-7a0cfc4c.js');
require('../_chunks/dep-9c74d22d.js');
require('../_chunks/dep-bc486aab.js');
require('../_chunks/dep-c7adf4af.js');
require('../_chunks/dep-f0639562.js');
require('../tree/useStore.js');
require('../_chunks/dep-35453ccd.js');
require('../_chunks/dep-c57ef5b6.js');
require('../_chunks/dep-4f605641.js');
require('../_chunks/dep-6681bc7b.js');
require('../_chunks/dep-4a02b995.js');
require('../_chunks/dep-7d00ab60.js');
require('../_chunks/dep-a81e362c.js');
require('../_chunks/dep-55c2ba72.js');
require('../_chunks/dep-d2229c5d.js');
require('../_chunks/dep-9e6db8fb.js');
require('../_chunks/dep-552722c0.js');
require('../_util/useUpdateEffect.js');
require('../_chunks/dep-87ec326c.js');
require('../_chunks/dep-b000fdae.js');
require('../_chunks/dep-8f3deb2a.js');
require('../_chunks/dep-af921283.js');
require('../_common/js/tree/tree-node-model.js');
require('../_chunks/dep-59b9b071.js');
require('../_chunks/dep-15af0f44.js');
require('../_chunks/dep-66fbd01b.js');
require('../tag/index.js');
require('../tag/Tag.js');
require('../tag/CheckTag.js');
require('../input/index.js');
require('../input/Input.js');
require('../input/InputGroup.js');
require('../_util/useDefaultValue.js');
require('../common/FakeArrow.js');
require('../_util/useCommonClassName.js');

function _interopDefaultLegacy (e) { return e && typeof e === 'object' && 'default' in e ? e : { 'default': e }; }

var React__default = /*#__PURE__*/_interopDefaultLegacy(React);

var baseGetTag = _baseGetTag._baseGetTag,
    isObjectLike = isObjectLike$1.isObjectLike_1;
/** `Object#toString` result references. */

var boolTag = '[object Boolean]';
/**
 * Checks if `value` is classified as a boolean primitive or object.
 *
 * @static
 * @memberOf _
 * @since 0.1.0
 * @category Lang
 * @param {*} value The value to check.
 * @returns {boolean} Returns `true` if `value` is a boolean, else `false`.
 * @example
 *
 * _.isBoolean(false);
 * // => true
 *
 * _.isBoolean(null);
 * // => false
 */

function isBoolean(value) {
  return value === true || value === false || isObjectLike(value) && baseGetTag(value) == boolTag;
}

var isBoolean_1 = isBoolean;

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { defineProperty._defineProperty(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }
var TreeSelect = /*#__PURE__*/React.forwardRef(function (props, ref) {
  var treeSelectClassName = props.className,
      treeSelectStyle = props.style,
      disabled = props.disabled,
      multiple = props.multiple,
      prefixIcon = props.prefixIcon,
      valueType = props.valueType,
      loading = props.loading,
      max = props.max,
      treeProps = props.treeProps,
      empty = props.empty,
      data = props.data,
      loadingText = props.loadingText,
      filter = props.filter,
      filterable = props.filterable,
      onClear = props.onClear;

  var _useConfig = _util_useConfig["default"](),
      classPrefix = _useConfig.classPrefix;

  var popupRef = React.useRef(null);
  var treeRef = React.useRef(null);
  var inputRef = React.useRef(null);

  var _useState = React.useState(false),
      _useState2 = slicedToArray._slicedToArray(_useState, 2),
      visible = _useState2[0],
      setVisible = _useState2[1];

  var _useState3 = React.useState(false),
      _useState4 = slicedToArray._slicedToArray(_useState3, 2),
      isHover = _useState4[0],
      setIsHover = _useState4[1];

  var _useState5 = React.useState(false),
      _useState6 = slicedToArray._slicedToArray(_useState5, 2),
      focusing = _useState6[0],
      setFocusing = _useState6[1];

  var _useState7 = React.useState(""),
      _useState8 = slicedToArray._slicedToArray(_useState7, 2),
      filterText = _useState8[0],
      setFilterText = _useState8[1];

  var _useState9 = React.useState([]),
      _useState10 = slicedToArray._slicedToArray(_useState9, 2),
      actived = _useState10[0],
      setActived = _useState10[1];

  var _useState11 = React.useState([]),
      _useState12 = slicedToArray._slicedToArray(_useState11, 2),
      expanded = _useState12[0],
      setExpanded = _useState12[1];

  var _useState13 = React.useState(null),
      _useState14 = slicedToArray._slicedToArray(_useState13, 2),
      nodeInfo = _useState14[0],
      setNodeInfo = _useState14[1];

  var _useDefault = _util_useDefault["default"](props.value, props.defaultValue, props.onChange),
      _useDefault2 = slicedToArray._slicedToArray(_useDefault, 2),
      value = _useDefault2[0],
      onChange = _useDefault2[1];

  var _useTreeSelectConfig = treeSelect_useTreeSelectConfig["default"](_objectSpread({
    visible: visible
  }, props)),
      selectClassName = _useTreeSelectConfig.selectClassName,
      popupObject = _useTreeSelectConfig.popupObject,
      popupClassName = _useTreeSelectConfig.popupClassName;

  var defaultStore = new _common_js_tree_treeStore.TreeStore(_objectSpread({}, treeProps));
  defaultStore.append(data);

  var defaultGetTreeItem = function defaultGetTreeItem(value2) {
    var node = defaultStore.getNode(value2);
    return node === null || node === void 0 ? void 0 : node.getModel();
  };

  var selectedMultiple = React.useMemo(function () {
    if (multiple && isArray.isArray_1(value) && !isEmpty.isEmpty_1(value)) {
      return value;
    }

    return [];
  }, [multiple, value]);
  var selectedSingle = React.useMemo(function () {
    if (multiple) return "";

    if (typeof value === "undefined") {
      return nodeInfo ? nodeInfo.label : "";
    }

    return nodeInfo ? nodeInfo.label : "".concat(value);
  }, [multiple, value, nodeInfo]);
  var checked = React.useMemo(function () {
    if (multiple) {
      if (valueType === "object") {
        return isArray.isArray_1(value) ? value.map(function (item) {
          return item.value;
        }) : [];
      }

      return isArray.isArray_1(value) ? value : [];
    }

    return [];
  }, [multiple, valueType, value]);
  var showLoading = React.useMemo(function () {
    return loading && !disabled;
  }, [loading, disabled]);
  var showFilter = React.useMemo(function () {
    if (disabled) {
      return false;
    }

    if (!multiple && selectedSingle && (filterable || isFunction.isFunction_1(filter))) {
      return visible;
    }

    return filterable || isFunction.isFunction_1(filter);
  }, [disabled, multiple, selectedSingle, filterable, visible, filter]);
  var multiLimitDisabled = React.useMemo(function () {
    if (multiple && max && isArray.isArray_1(value) && max <= value.length) {
      return true;
    }

    return false;
  }, [multiple, max, value]);
  var realLabel = React.useMemo(function () {
    if (!isEmpty.isEmpty_1(treeProps) && !isEmpty.isEmpty_1(treeProps.keys)) {
      return treeProps.keys.label || "label";
    }

    return "label";
  }, [treeProps]);
  var realValue = React.useMemo(function () {
    if (!isEmpty.isEmpty_1(treeProps) && !isEmpty.isEmpty_1(treeProps.keys)) {
      return treeProps.keys.value || "value";
    }

    return "value";
  }, [treeProps]);
  var tagList = React.useMemo(function () {
    if (nodeInfo && isArray.isArray_1(nodeInfo)) {
      return nodeInfo.map(function (node) {
        return node.label;
      });
    }

    return selectedMultiple;
  }, [nodeInfo, selectedMultiple]);
  var filterByText = React.useCallback(function (node) {
    if (isFunction.isFunction_1(filter)) {
      var filterValue = filter(filterText, node);

      if (isBoolean_1(filterValue)) {
        return filterValue;
      }
    }

    return node.data[realLabel].indexOf(filterText) >= 0;
  }, [filterText, realLabel, filter]);
  React.useEffect(function () {
    if (valueType === "object") {
      setActived(isArray.isArray_1(value) ? value.map(function (item) {
        return item.value;
      }) : [value.value]);
    } else {
      setActived(isArray.isArray_1(value) ? value : [value]);
    }

    changeNodeInfo(value);
  }, [value, valueType]);

  function handleClear(e) {
    e.stopPropagation();
    var defaultValue = multiple ? [] : "";
    onChange === null || onChange === void 0 ? void 0 : onChange(defaultValue, null);
    setActived([]);
    setFilterText("");
    setNodeInfo(null);
    onClear === null || onClear === void 0 ? void 0 : onClear({
      e: e
    });
  }

  function changeNodeInfo(value2) {
    if (!multiple && value2) {
      var _treeRef$current;

      var nodeValue = valueType === "object" ? value2.value : value2;
      var node = ((_treeRef$current = treeRef.current) === null || _treeRef$current === void 0 ? void 0 : _treeRef$current.getItem(nodeValue)) || defaultGetTreeItem(nodeValue);
      node ? setNodeInfo({
        label: node.data[realLabel],
        value: node.data[realValue]
      }) : setNodeInfo(null);
    } else if (multiple && isArray.isArray_1(value2)) {
      setNodeInfo(value2.map(function (value3) {
        var _treeRef$current2;

        var nodeValue = valueType === "object" ? value3.value : value3;
        var node = ((_treeRef$current2 = treeRef.current) === null || _treeRef$current2 === void 0 ? void 0 : _treeRef$current2.getItem(nodeValue)) || defaultGetTreeItem(nodeValue);
        return node ? {
          label: node.data[realLabel],
          value: node.data[realValue]
        } : {};
      }));
    } else {
      setNodeInfo(null);
    }
  }

  function treeNodeChange(value2, context) {
    var current = value2;

    if (valueType === "object") {
      current = value2.map(function (nodeValue) {
        var node = treeRef.current.getItem(nodeValue);
        return {
          label: node.data[realLabel],
          value: node.data[realValue]
        };
      });
    }

    onChange === null || onChange === void 0 ? void 0 : onChange(current, context);
  }

  function treeNodeActive(value2, context) {
    if (multiple) return;
    var nodeValue = isEmpty.isEmpty_1(value2) ? "" : value2[0];
    var node = treeRef.current.getItem(nodeValue);
    var current = nodeValue;

    if (valueType === "object" && node) {
      current = {
        label: node.data[realLabel],
        value: node.data[realValue]
      };
    }

    onChange === null || onChange === void 0 ? void 0 : onChange(current, context);
    setFilterText("");
    setVisible(false);
  }

  function treeNodeExpand(value2) {
    setExpanded(value2);
  }

  function popupVisibleChange(visible2) {
    if (focusing && !visible2) {
      setVisible(true);
      return;
    }

    setVisible(visible2);

    if (showFilter && visible2) {
      var _inputRef$current;

      (_inputRef$current = inputRef.current) === null || _inputRef$current === void 0 ? void 0 : _inputRef$current.focus();
    }
  }

  var _useLocaleReceiver = locale_LocalReceiver.useLocaleReceiver("treeSelect"),
      _useLocaleReceiver2 = slicedToArray._slicedToArray(_useLocaleReceiver, 2),
      local = _useLocaleReceiver2[0],
      t = _useLocaleReceiver2[1];

  var emptyText = t(local.empty);
  var loadingTextLabel = t(local.loadingText);
  var treeItem = !loading && /* @__PURE__ */React__default["default"].createElement(tree_index.Tree, _objectSpread({
    ref: treeRef,
    value: checked,
    hover: true,
    expandAll: true,
    expandOnClickNode: true,
    data: data,
    activable: !multiple,
    checkable: multiple,
    disabled: disabled || multiLimitDisabled,
    empty: empty || /* @__PURE__ */React__default["default"].createElement("div", {
      className: "".concat(classPrefix, "-select__empty")
    }, emptyText),
    filter: filterByText,
    actived: actived,
    expanded: expanded,
    activeMultiple: multiple,
    onChange: treeNodeChange,
    onActive: treeNodeActive,
    onExpand: treeNodeExpand
  }, treeProps));
  var loadingTip = showLoading && /* @__PURE__ */React__default["default"].createElement("p", {
    className: "".concat(classPrefix, "-select__loading-tips")
  }, loadingText || /* @__PURE__ */React__default["default"].createElement("div", {
    className: "".concat(classPrefix, "-select__empty")
  }, loadingTextLabel));
  return /* @__PURE__ */React__default["default"].createElement("div", {
    ref: ref,
    className: treeSelectClassName,
    style: treeSelectStyle
  }, /* @__PURE__ */React__default["default"].createElement(popup_index.Popup, {
    ref: popupRef,
    className: "".concat(classPrefix, "-select__popup-reference"),
    visible: visible,
    disabled: disabled,
    placement: popupObject.placement,
    trigger: popupObject.trigger,
    overlayStyle: popupObject.overlayStyle,
    overlayClassName: popupClassName,
    onVisibleChange: popupVisibleChange,
    expandAnimation: true,
    destroyOnClose: true,
    content: /* @__PURE__ */React__default["default"].createElement(React__default["default"].Fragment, null, loadingTip, treeItem)
  }, /* @__PURE__ */React__default["default"].createElement("div", {
    style: {
      minHeight: 30
    },
    className: selectClassName,
    onMouseEnter: function onMouseEnter() {
      return setIsHover(true);
    },
    onMouseLeave: function onMouseLeave() {
      return setIsHover(false);
    }
  }, prefixIcon && /* @__PURE__ */React__default["default"].createElement("span", {
    className: "".concat(classPrefix, "-select__left-icon")
  }, prefixIcon), /* @__PURE__ */React__default["default"].createElement(treeSelect_TreeSelectTags["default"], _objectSpread({
    tagList: tagList
  }, props)), /* @__PURE__ */React__default["default"].createElement(treeSelect_TreeSelectInput["default"], _objectSpread({
    ref: inputRef,
    visible: visible,
    filterText: filterText,
    selectedSingle: selectedSingle,
    setFocusing: setFocusing,
    setFilterText: setFilterText
  }, props)), /* @__PURE__ */React__default["default"].createElement(treeSelect_TreeSelectSuffix["default"], _objectSpread({
    visible: visible,
    isHover: isHover,
    showLoading: showLoading,
    handleClear: handleClear
  }, props)))));
});
TreeSelect.displayName = "TreeSelect";
TreeSelect.defaultProps = {
  clearable: false,
  data: [],
  disabled: false,
  empty: "",
  filterable: false,
  loading: false,
  loadingText: "",
  max: 0,
  multiple: false,
  placeholder: "\u8BF7\u8F93\u5165",
  size: "medium",
  valueType: "value",
  minCollapsedNum: 0
};

exports["default"] = TreeSelect;
//# sourceMappingURL=TreeSelect.js.map
