{"version":3,"file":"Affix.js","sources":["../../src/affix/Affix.tsx"],"sourcesContent":["import React, { useState, useEffect, forwardRef, useCallback, useImperativeHandle, useRef } from 'react';\nimport isFunction from 'lodash/isFunction';\nimport { StyledProps , ScrollContainerElement } from '../common';\nimport { TdAffixProps } from './type';\nimport { getScrollContainer } from '../_util/dom';\nimport useConfig from '../_util/useConfig';\n\nexport interface AffixProps extends TdAffixProps, StyledProps {}\n\ninterface StateRef {\n  ticking: boolean;\n  oldWidth: number;\n  oldHeight: number;\n  containerHeight: number;\n  scrollContainer?: ScrollContainerElement;\n}\n\ninterface RefProps {\n  calcInitValue: () => void;\n  handleScroll: () => void;\n}\n\nconst Affix = forwardRef<RefProps, AffixProps>((props, ref) => {\n  const { children, container = () => window, offsetBottom, offsetTop, onFixedChange } = props;\n\n  const [affixed, setAffixed] = useState<boolean>(false);\n  const { classPrefix } = useConfig();\n\n  const affixRef = useRef<HTMLDivElement>();\n  const affixWrapRef = useRef<HTMLDivElement>();\n  const stateRef = useRef<StateRef>({ ticking: false, oldWidth: 0, oldHeight: 0, containerHeight: 0 });\n\n  const handleScroll = useCallback(() => {\n    const { ticking, scrollContainer, containerHeight, oldWidth } = stateRef.current;\n    if (!ticking) {\n      window.requestAnimationFrame(() => {\n        const affixEl = affixRef.current;\n        const { top } = affixWrapRef.current.getBoundingClientRect(); // top = 节点到页面顶部的距离，包含 scroll 中的高度\n        let containerTop = 0; // containerTop = 容器到页面顶部的距离\n        if (scrollContainer instanceof HTMLElement) {\n          containerTop = scrollContainer.getBoundingClientRect().top;\n        }\n        let fixedTop: number | false;\n        const calcTop = top - containerTop; // 节点顶部到 container 顶部的距离\n        const calcBottom = containerTop + containerHeight - offsetBottom; // 计算 bottom 相对应的 top 值\n        if (offsetTop !== undefined && calcTop <= offsetTop) {\n          // top 的触发\n          fixedTop = containerTop + offsetTop;\n        } else if (offsetBottom !== undefined && top >= calcBottom) {\n          // bottom 的触发\n          fixedTop = calcBottom;\n        } else {\n          fixedTop = false;\n        }\n\n        if (fixedTop !== false) {\n          affixEl.className = `${classPrefix}-affix`;\n          affixEl.style.top = `${fixedTop}px`;\n          affixEl.style.width = `${oldWidth}px`;\n        } else {\n          affixEl.removeAttribute('class');\n          affixEl.removeAttribute('style');\n        }\n        setAffixed(!!fixedTop);\n        if (isFunction(onFixedChange)) onFixedChange(!!fixedTop, { top: fixedTop });\n        stateRef.current.ticking = false;\n      });\n    }\n    stateRef.current.ticking = true;\n  }, [classPrefix, offsetBottom, offsetTop, onFixedChange]);\n\n  const calcInitValue = useCallback(() => {\n    const scrollContainer = getScrollContainer(container);\n    if (!scrollContainer) return;\n    // 获取当前可视的高度\n    let containerHeight = 0;\n    if (scrollContainer instanceof Window) {\n      containerHeight = scrollContainer.innerHeight;\n    } else {\n      containerHeight = scrollContainer.clientHeight;\n    }\n    // 被包裹的子节点宽高\n    const { clientWidth, clientHeight } = affixRef.current || {};\n    stateRef.current = {\n      ...stateRef.current,\n      scrollContainer,\n      oldWidth: clientWidth,\n      oldHeight: clientHeight,\n      containerHeight: containerHeight - clientHeight,\n    };\n\n    handleScroll();\n  }, [container, handleScroll]);\n\n  useImperativeHandle(ref, () => ({\n    calcInitValue,\n    handleScroll,\n  }));\n\n  useEffect(() => {\n    calcInitValue();\n    if (stateRef.current.scrollContainer) {\n      stateRef.current.scrollContainer.addEventListener('scroll', handleScroll);\n      window.addEventListener('resize', handleScroll);\n      return () => {\n        stateRef.current.scrollContainer.removeEventListener('scroll', handleScroll);\n        window.removeEventListener('resize', handleScroll);\n      };\n    }\n  }, [calcInitValue, handleScroll]);\n\n  const { oldWidth, oldHeight } = stateRef.current;\n\n  return (\n    <div ref={affixWrapRef}>\n      {affixed ? <div style={{ width: `${oldWidth}px`, height: `${oldHeight}px` }}></div> : ''}\n      <div ref={affixRef}>{children}</div>\n    </div>\n  );\n});\n\nexport default Affix;\n"],"names":["Affix","forwardRef","props","ref","children","container","window","offsetBottom","offsetTop","onFixedChange","useState","affixed","setAffixed","useConfig","classPrefix","affixRef","useRef","affixWrapRef","stateRef","ticking","oldWidth","oldHeight","containerHeight","handleScroll","useCallback","current","scrollContainer","oldWidth2","requestAnimationFrame","affixEl","getBoundingClientRect","top","containerTop","HTMLElement","fixedTop","calcTop","calcBottom","className","style","width","removeAttribute","isFunction","calcInitValue","getScrollContainer","Window","innerHeight","clientHeight","clientWidth","useImperativeHandle","useEffect","addEventListener","removeEventListener","React","createElement","height"],"mappings":"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"}