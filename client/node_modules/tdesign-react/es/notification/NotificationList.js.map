{"version":3,"file":"NotificationList.js","sources":["../../src/notification/NotificationList.tsx"],"sourcesContent":["import React, { forwardRef } from 'react';\nimport ReactDOM from 'react-dom';\nimport useConfig from '../_util/useConfig';\nimport {\n  NotificationInfoOptions,\n  NotificationInstance,\n  NotificationPlacementList,\n  NotificationThemeList,\n  TdNotificationProps,\n} from './type';\nimport { Styles } from '../common';\nimport noop from '../_util/noop';\nimport { NotificationComponent } from './Notification';\n\ninterface NotificationListInstance extends TdNotificationProps {\n  push: (theme: NotificationThemeList, options: NotificationInfoOptions) => Promise<NotificationInstance>;\n  remove: (key: string) => void;\n  removeAll: () => void;\n}\n\ninterface NotificationListOpenOption extends NotificationInfoOptions {\n  key: string;\n  theme: NotificationThemeList;\n  style: Styles;\n}\n\ninterface NotificationListProps {\n  attach: HTMLElement;\n  zIndex: number;\n  placement: NotificationPlacementList;\n}\n\ntype NotificationRef = React.RefObject<React.ElementRef<'div'>> & React.RefObject<NotificationInstance>;\n\nlet seed = 0;\n\nexport const listMap: Map<NotificationPlacementList, NotificationListInstance> = new Map();\n\nconst NotificationList = forwardRef<NotificationListInstance, NotificationListProps>((props, ref) => {\n  const { attach, placement, zIndex } = props;\n  const { classPrefix } = useConfig();\n  const [list, dispatchList] = React.useReducer(\n    (\n      state: NotificationListOpenOption[],\n      action: {\n        type: string;\n        key?: string;\n        value?: NotificationListOpenOption;\n      },\n    ) => {\n      switch (action.type) {\n        case 'push':\n          return [...state, action.value];\n        case 'remove':\n          return state.filter((item) => item.key !== action.key).map((item) => item);\n        case 'removeAll':\n          return [];\n        default:\n          return state;\n      }\n    },\n    [],\n  );\n  const notificationMap = React.useMemo<Map<string, NotificationRef>>(() => new Map(), []);\n\n  const remove = React.useCallback(\n    (key: string): void => {\n      dispatchList({ type: 'remove', key });\n      notificationMap.delete(key);\n    },\n    [notificationMap],\n  );\n\n  const calOffset = (offset: string | number) => {\n    if (!offset) return '16px';\n    return isNaN(Number(offset)) ? offset : `${offset}px`;\n  };\n  /* eslint-disable implicit-arrow-linebreak */\n  const push = React.useCallback(\n    (theme: NotificationThemeList, options: NotificationInfoOptions): Promise<NotificationInstance> =>\n      new Promise((resolve) => {\n        const key = String((seed += 1));\n        const style: React.CSSProperties = (() => {\n          if (Array.isArray(options.offset)) {\n            const [horizontal, vertical] = [...options.offset];\n            const horizontalOffset = calOffset(horizontal);\n            const verticalOffset = calOffset(vertical);\n\n            return {\n              marginTop: verticalOffset,\n              marginBottom: verticalOffset,\n              marginLeft: horizontalOffset,\n              marginRight: horizontalOffset,\n            };\n          }\n          return {\n            margin: '16px',\n          };\n        })();\n        notificationMap.set(key, React.createRef());\n        dispatchList({ type: 'push', value: { ...options, key, theme, style } });\n        notificationMap.get(key).current.close = () => {\n          remove(key);\n        };\n        resolve(notificationMap.get(key).current);\n      }),\n    [notificationMap, remove],\n  );\n\n  const removeAll = React.useCallback(() => {\n    dispatchList({ type: 'removeAll' });\n    notificationMap.clear();\n  }, [notificationMap]);\n\n  React.useImperativeHandle(ref, () => ({\n    push,\n    remove,\n    removeAll,\n  }));\n\n  React.useEffect(() => {\n    if (list.length === 0 && notificationMap.size === 0) {\n      listMap.delete(placement);\n      ReactDOM.unmountComponentAtNode(attach);\n      attach.remove();\n    }\n  }, [list, attach, placement, notificationMap]);\n\n  return (\n    <div className={`${classPrefix}-notification__show--${placement}`} style={{ zIndex }}>\n      {list.map((props) => {\n        const { onDurationEnd = noop, onCloseBtnClick = noop } = props;\n\n        return (\n          <NotificationComponent\n            theme={'warning'}\n            ref={notificationMap.get(props.key)}\n            key={props.key}\n            {...props}\n            onDurationEnd={() => {\n              remove(props.key);\n              onDurationEnd();\n            }}\n            onCloseBtnClick={(e) => {\n              remove(props.key);\n              onCloseBtnClick(e);\n            }}\n          />\n        );\n      })}\n    </div>\n  );\n});\n\nexport const fetchListInstance = (\n  placement: NotificationPlacementList,\n  attach: HTMLElement,\n  zIndex: number,\n): Promise<NotificationListInstance> =>\n  new Promise((resolve) => {\n    if (listMap.has(placement)) {\n      resolve(listMap.get(placement));\n    } else {\n      let hasExec = false;\n      ReactDOM.render(\n        <NotificationList\n          attach={attach}\n          placement={placement}\n          zIndex={Number(zIndex)}\n          ref={(instance) => {\n            if (!hasExec) {\n              hasExec = true;\n              listMap.set(placement, instance);\n              resolve(instance);\n            }\n          }}\n        />,\n        attach,\n      );\n    }\n  });\n"],"names":["seed","listMap","Map","NotificationList","forwardRef","props","ref","attach","placement","zIndex","useConfig","classPrefix","React","useReducer","state","action","type","value","filter","item","key","map","list","dispatchList","notificationMap","useMemo","remove","useCallback","calOffset","offset","isNaN","Number","push","theme","options","Promise","resolve","String","style","Array","isArray","horizontal","vertical","horizontalOffset","verticalOffset","marginTop","marginBottom","marginLeft","marginRight","margin","set","createRef","get","current","close","removeAll","clear","useImperativeHandle","useEffect","length","size","ReactDOM","unmountComponentAtNode","createElement","className","props2","onDurationEnd","noop","onCloseBtnClick","NotificationComponent","e","fetchListInstance","has","hasExec","render","instance"],"mappings":"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"}