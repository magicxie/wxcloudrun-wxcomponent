{"version":3,"file":"Anchor.js","sources":["../../src/anchor/Anchor.tsx"],"sourcesContent":["import React, { useState, useRef, useEffect, useCallback } from 'react';\nimport classNames from 'classnames';\nimport isEmpty from 'lodash/isEmpty';\nimport isFunction from 'lodash/isFunction';\nimport { StyledProps } from '../common';\nimport { TdAnchorProps } from './type';\nimport useConfig from '../_util/useConfig';\nimport noop from '../_util/noop';\nimport { getScrollContainer } from '../_util/dom';\nimport Affix from '../affix';\nimport { AnchorContext, Item } from './AnchorContext';\nimport { getOffsetTop, getScroll, scrollTo, AnchorContainer } from './_util/dom';\nimport AnchorItem from './AnchorItem';\nimport AnchorTarget from './AnchorTarget';\n\nexport interface AnchorProps extends TdAnchorProps, StyledProps {\n  children?: React.ReactNode;\n}\n\ninterface IntervalRef {\n  // 收集 anchor-item\n  items: string[];\n  // 容器\n  scrollContainer: AnchorContainer;\n  // 收集各项 item 的信息与节点\n  handleScrollLock: boolean;\n}\n\nconst ANCHOR_SHARP_REGEXP = /#(\\S+)$/;\n\nconst Anchor = (props: AnchorProps) => {\n  const {\n    affixProps,\n    bounds = 5,\n    targetOffset = 0,\n    container = '',\n    size = 'medium',\n    children,\n    cursor,\n    onClick = noop,\n    onChange = noop,\n  } = props;\n\n  const { classPrefix } = useConfig();\n\n  const [activeItem, setActiveItem] = useState<string>('');\n  const [cursorStyle, setCursorStyle] = useState<{ top: string; height?: string; opacity: number }>({\n    top: '0px',\n    height: '0px',\n    opacity: 0,\n  });\n\n  const anchorEl = useRef(null);\n  const intervalRef = useRef<IntervalRef>({\n    items: [],\n    scrollContainer: window,\n    handleScrollLock: false,\n  });\n\n  /**\n   * 注册锚点\n   * @param href 链接\n   */\n  const registerItem = (href: string): void => {\n    const { items } = intervalRef.current;\n    if (ANCHOR_SHARP_REGEXP.test(href) && items.indexOf(href) < 0) items.push(href);\n  };\n\n  const unregisterItem = (href: string): void => {\n    const { items } = intervalRef.current;\n    intervalRef.current.items = items.filter((item) => href !== item);\n  };\n\n  const getAnchorTarget = (href: string): HTMLElement => document.querySelector(href);\n\n  const handleScrollTo = (link: string) => {\n    const anchor = getAnchorTarget(link);\n    if (!anchor) return;\n    if (isFunction(onChange)) onChange(link, activeItem);\n    setActiveItem(link);\n    intervalRef.current.handleScrollLock = true;\n    const { scrollContainer } = intervalRef.current;\n    const scrollTop = getScroll(scrollContainer);\n    const offsetTop = getOffsetTop(anchor, scrollContainer);\n    const top = scrollTop + offsetTop - targetOffset;\n    scrollTo(top, {\n      container: scrollContainer,\n    }).then(() => {\n      intervalRef.current.handleScrollLock = false;\n    });\n  };\n\n  const handleClick = (item: Item, e: React.MouseEvent<HTMLDivElement>) => {\n    onClick({ e, ...item });\n    handleScrollTo(item.href);\n  };\n\n  useEffect(() => {\n    // update point style\n    const pointEl = anchorEl.current.querySelector(`.${classPrefix}-is-active>a`) as HTMLAnchorElement;\n    if (!pointEl) {\n      setCursorStyle(null);\n    } else {\n      const { offsetTop: top, offsetHeight: height } = pointEl;\n      setCursorStyle({ top: `${top}px`, height: `${height}px`, opacity: 1 });\n    }\n  }, [activeItem, classPrefix]);\n\n  const handleScroll = useCallback(() => {\n    const { scrollContainer, handleScrollLock } = intervalRef.current;\n    if (handleScrollLock) return;\n    const { items } = intervalRef.current;\n    const filters: { top: number; href: string }[] = [];\n    let active = '';\n    // 找出所有当前top小于预设值\n    items.forEach((href) => {\n      const anchor = getAnchorTarget(href);\n      if (!anchor) return;\n      const top = getOffsetTop(anchor, scrollContainer);\n      if (top <= bounds + targetOffset) {\n        filters.push({\n          href,\n          top,\n        });\n      }\n    });\n\n    // 找出小于预设值集合中top最大的\n    if (filters.length) {\n      const latest = filters.reduce((prev, cur) => (prev.top > cur.top ? prev : cur));\n      active = latest.href;\n    }\n    if (active !== activeItem) {\n      if (isFunction(onChange)) onChange(active, activeItem);\n      setActiveItem(active);\n    }\n  }, [activeItem, bounds, onChange, targetOffset]);\n\n  useEffect(() => {\n    intervalRef.current.scrollContainer = getScrollContainer(container);\n    const { scrollContainer } = intervalRef.current;\n\n    handleScroll();\n    scrollContainer.addEventListener('scroll', handleScroll);\n    return () => {\n      scrollContainer.removeEventListener('scroll', handleScroll);\n    };\n  }, [container, handleScroll]);\n\n  const anchorClass = classNames(`${classPrefix}-anchor`, {\n    [`${classPrefix}-size-s`]: size === 'small',\n    [`${classPrefix}-size-m`]: size === 'medium',\n    [`${classPrefix}-size-l`]: size === 'large',\n  });\n\n  const CursorCmp = () => {\n    if (isFunction(cursor)) return cursor();\n    if (isEmpty(cursor)) return <div className={`${classPrefix}-anchor__line-cursor`}></div>;\n    return cursor;\n  };\n\n  const Cmp = (\n    <AnchorContext.Provider\n      value={{\n        onClick: handleClick,\n        activeItem,\n        registerItem,\n        unregisterItem,\n      }}\n    >\n      <div className={anchorClass} ref={anchorEl}>\n        <div className={`${classPrefix}-anchor__line`}>\n          <div className={`${classPrefix}-anchor__line-cursor-wrapper`} style={cursorStyle}>\n            {CursorCmp()}\n          </div>\n        </div>\n        {children}\n      </div>\n    </AnchorContext.Provider>\n  );\n\n  return isEmpty(affixProps) ? Cmp : <Affix {...affixProps}>{Cmp}</Affix>;\n};\n\nAnchor.AnchorItem = AnchorItem;\nAnchor.AnchorTarget = AnchorTarget;\n\nAnchor.displayName = 'Anchor';\n\nexport default Anchor;\n"],"names":["ANCHOR_SHARP_REGEXP","Anchor","props","affixProps","bounds","targetOffset","container","size","children","cursor","onClick","noop","onChange","useConfig","classPrefix","useState","activeItem","setActiveItem","top","height","opacity","cursorStyle","setCursorStyle","anchorEl","useRef","intervalRef","items","scrollContainer","window","handleScrollLock","registerItem","href","current","test","indexOf","push","unregisterItem","filter","item","getAnchorTarget","document","querySelector","handleScrollTo","link","anchor","isFunction","scrollTop","getScroll","offsetTop","getOffsetTop","scrollTo","then","handleClick","e","useEffect","pointEl","offsetHeight","handleScroll","useCallback","filters","active","forEach","length","latest","reduce","prev","cur","getScrollContainer","addEventListener","removeEventListener","anchorClass","classNames","CursorCmp","isEmpty","React","createElement","className","Cmp","AnchorContext","Provider","value","ref","style","Affix","AnchorItem","AnchorTarget","displayName"],"mappings":"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"}