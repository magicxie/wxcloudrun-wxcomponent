{"version":3,"file":"Form.js","sources":["../../src/form/Form.tsx"],"sourcesContent":["import React, { useRef, useImperativeHandle } from 'react';\nimport classNames from 'classnames';\nimport isEmpty from 'lodash/isEmpty';\nimport isFunction from 'lodash/isFunction';\nimport flatten from 'lodash/flatten';\nimport useConfig from '../_util/useConfig';\nimport noop from '../_util/noop';\nimport forwardRefWithStatics from '../_util/forwardRefWithStatics';\nimport { TdFormProps, FormInstance, Result } from './type';\nimport { StyledProps } from '../common';\nimport FormContext from './FormContext';\nimport FormItem from './FormItem';\n\nexport interface FormProps extends TdFormProps, StyledProps {\n  children?: React.ReactNode;\n}\n\nconst Form = forwardRefWithStatics(\n  (props: FormProps, ref) => {\n    const {\n      style,\n      className,\n      labelWidth = '100px',\n      statusIcon,\n      labelAlign = 'right',\n      layout = 'vertical',\n      size = 'medium',\n      colon = false,\n      requiredMark = true,\n      scrollToFirstError,\n      showErrorMessage = true,\n      resetType = 'empty',\n      rules,\n      children,\n      onSubmit,\n      onReset,\n      onValuesChange = noop,\n    } = props;\n    const { classPrefix } = useConfig();\n    const formClass = classNames(className, `${classPrefix}-form`, {\n      [`${classPrefix}-form-inline`]: layout === 'inline',\n    });\n\n    const formItemsRef = useRef([]);\n\n    const FORM_ITEM_CLASS_PREFIX = `${classPrefix}-form-item__`;\n\n    function getFirstError(r: Result) {\n      if (r === true) return;\n      const [firstKey] = Object.keys(r);\n      if (scrollToFirstError) {\n        scrollTo(`.${FORM_ITEM_CLASS_PREFIX + firstKey}`);\n      }\n      return r[firstKey][0]?.message;\n    }\n    // 校验不通过时，滚动到第一个错误表单\n    function scrollTo(selector: string) {\n      const dom = document.querySelector(selector);\n      const behavior = scrollToFirstError as ScrollBehavior;\n      dom && dom.scrollIntoView({ behavior });\n    }\n\n    function submitHandler(e: React.FormEvent<HTMLFormElement>) {\n      e?.preventDefault();\n      validate().then((r) => {\n        getFirstError(r);\n        onSubmit?.({ validateResult: r, e });\n      });\n    }\n    function resetHandler(e: React.FormEvent<HTMLFormElement>) {\n      e?.preventDefault();\n      formItemsRef.current.forEach(({ current: formItemRef }) => {\n        if (!isFunction(formItemRef.resetField)) return;\n        formItemRef.resetField();\n      });\n      onReset?.({ e });\n    }\n\n    // 对外方法，该方法会触发全部表单组件错误信息显示\n    function validate(param?: Record<string, any>): Promise<Result> {\n      function needValidate(name: string, fields: string[]) {\n        if (!fields || !Array.isArray(fields)) return true;\n        return fields.indexOf(name) !== -1;\n      }\n\n      const { fields, trigger = 'all' } = param || {};\n      const list = formItemsRef.current\n        .filter(\n          ({ current: formItemRef }) => isFunction(formItemRef.validate) && needValidate(formItemRef.name, fields),\n        )\n        .map(({ current: formItemRef }) => formItemRef.validate(trigger));\n\n      return new Promise((resolve) => {\n        Promise.all(flatten(list))\n          .then((arr: any) => {\n            const r = arr.reduce((r, err) => Object.assign(r || {}, err), {});\n            Object.keys(r).forEach((key) => {\n              if (r[key] === true) {\n                delete r[key];\n              }\n            });\n            resolve(isEmpty(r) ? true : r);\n          })\n          .catch(console.error);\n      });\n    }\n\n    // 对外方法，获取整个表单的值\n    function getAllFieldsValue() {\n      const fieldsValue = {};\n      formItemsRef.current.forEach(({ current: formItemRef }) => {\n        // 过滤无 name 的数据\n        if (formItemRef.name) {\n          fieldsValue[formItemRef.name] = formItemRef.value;\n        }\n      });\n\n      return fieldsValue;\n    }\n\n    // 对外方法，获取对应 formItem 的值\n    function getFieldValue(name: string) {\n      if (!name) return null;\n      const target = formItemsRef.current.find(({ current: formItemRef }) => formItemRef.name === name);\n      return target && target.value;\n    }\n\n    // 对外方法，设置对应 formItem 的值\n    function setFieldsValue(fileds = {}) {\n      const formItemsMap = formItemsRef.current.reduce((acc, { current: currItem }) => {\n        const { name } = currItem;\n        return { ...acc, [name]: currItem };\n      }, {});\n      Object.keys(fileds).forEach((key) => {\n        formItemsMap[key]?.setValue(fileds[key]);\n      });\n    }\n\n    // 对外方法，设置对应 formItem 的数据\n    function setFields(fileds = []) {\n      if (!Array.isArray(fileds)) throw new Error('setFields 参数需要 Array 类型');\n      const formItemsMap = formItemsRef.current.reduce((acc, { current: currItem }) => {\n        const { name } = currItem;\n        return { ...acc, [name]: currItem };\n      }, {});\n      fileds.forEach((filed) => {\n        const { name, value, status } = filed;\n        formItemsMap[name]?.setField({ value, status });\n      });\n    }\n\n    useImperativeHandle(\n      ref,\n      (): FormInstance => ({\n        submit: submitHandler,\n        reset: resetHandler,\n        getFieldValue,\n        setFieldsValue,\n        setFields,\n        validate,\n        getAllFieldsValue,\n      }),\n    );\n\n    function onFormItemValueChange(changedValue: Record<string, unknown>) {\n      const allFileds = getAllFieldsValue();\n      onValuesChange(changedValue, allFileds);\n    }\n\n    return (\n      <FormContext.Provider\n        value={{\n          labelWidth,\n          statusIcon,\n          labelAlign,\n          layout,\n          size,\n          colon,\n          requiredMark,\n          showErrorMessage,\n          scrollToFirstError,\n          resetType,\n          rules,\n          formItemsRef,\n          onFormItemValueChange,\n        }}\n      >\n        <form className={formClass} style={style} onSubmit={submitHandler} onReset={resetHandler} ref={ref}>\n          {children}\n        </form>\n      </FormContext.Provider>\n    );\n  },\n  { FormItem },\n);\n\nForm.displayName = 'Form';\n\nexport default Form;\n"],"names":["Form","forwardRefWithStatics","props","ref","style","className","labelWidth","statusIcon","labelAlign","layout","size","colon","requiredMark","scrollToFirstError","showErrorMessage","resetType","rules","children","onSubmit","onReset","onValuesChange","noop","useConfig","classPrefix","formClass","classNames","formItemsRef","useRef","FORM_ITEM_CLASS_PREFIX","getFirstError","r","Object","keys","firstKey","scrollTo","message","selector","dom","document","querySelector","behavior","scrollIntoView","submitHandler","e","preventDefault","validate","then","validateResult","resetHandler","current","forEach","formItemRef","isFunction","resetField","param","needValidate","name","fields2","Array","isArray","indexOf","fields","trigger","list","filter","map","Promise","resolve","all","flatten","arr","reduce","r2","err","assign","key","isEmpty","console","error","getAllFieldsValue","fieldsValue","value","getFieldValue","target","find","setFieldsValue","fileds","formItemsMap","acc","currItem","setValue","setFields","Error","filed","status","setField","useImperativeHandle","submit","reset","onFormItemValueChange","changedValue","allFileds","React","createElement","FormContext","Provider","FormItem","displayName"],"mappings":"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"}