{"version":3,"file":"Popup.js","sources":["../../src/popup/Popup.tsx"],"sourcesContent":["import React, {\n  forwardRef,\n  CSSProperties,\n  useState,\n  useEffect,\n  cloneElement,\n  isValidElement,\n  useMemo,\n  useRef,\n} from 'react';\nimport { CSSTransition } from 'react-transition-group';\nimport classNames from 'classnames';\nimport { usePopper } from 'react-popper';\nimport Popper from '@popperjs/core';\nimport { StyledProps } from '../common';\nimport useDefault from '../_util/useDefault';\nimport useConfig from '../_util/useConfig';\nimport composeRefs from '../_util/composeRefs';\nimport usePrevious from '../_util/usePrevious';\nimport { TdPopupProps } from './type';\nimport Portal from './Portal';\nimport useTriggerProps from './hooks/useTriggerProps';\nimport usePopupCssTransition from './hooks/usePopupCssTransition';\n\nexport interface PopupProps extends TdPopupProps, StyledProps {\n  // 是否触发展开收起动画，内部下拉式组件使用\n  expandAnimation?: boolean;\n}\n\n/**\n * 修复参数对齐popper.js 组件展示方向，与TD组件定义有差异\n */\ntype PlacementDictionary = {\n  [Key in TdPopupProps['placement']]: Popper.Placement;\n};\n\nconst placementMap: PlacementDictionary = {\n  top: 'top',\n  'top-left': 'top-start',\n  'top-right': 'top-end',\n  bottom: 'bottom',\n  'bottom-left': 'bottom-start',\n  'bottom-right': 'bottom-end',\n  left: 'left',\n  'left-top': 'left-start',\n  'left-bottom': 'left-end',\n  right: 'right',\n  'right-top': 'right-start',\n  'right-bottom': 'right-end',\n};\n\nconst Popup = forwardRef<HTMLDivElement, PopupProps>((props, ref) => {\n  const {\n    trigger = 'hover',\n    content = null,\n    placement = 'top',\n    attach = 'body',\n    showArrow = false,\n    destroyOnClose = false,\n    className,\n    style,\n    overlayClassName,\n    overlayStyle,\n    triggerElement,\n    children = triggerElement,\n    disabled,\n    defaultVisible = false,\n    zIndex,\n    onVisibleChange,\n    expandAnimation,\n  } = props;\n  const { classPrefix } = useConfig();\n  const [visible, setVisible] = useDefault(props.visible, defaultVisible, onVisibleChange);\n  const preVisible = usePrevious(visible);\n\n  // refs\n  const [triggerRef, setTriggerRef] = useState<HTMLElement>(null);\n  const [overlayRef, setOverlayRef] = useState<HTMLDivElement>(null);\n\n  const contentRef = useRef<HTMLDivElement>(null);\n\n  // https://popper.js.org/react-popper/v2/faq/\n  const [firstUpdate, setFirstUpdate] = useState<boolean>(false);\n  const onPopperFirstUpdate = useMemo(\n    () => () => {\n      setFirstUpdate(true);\n    },\n    [],\n  );\n\n  const popperOptions = useMemo(() => {\n    if (!visible) return { padding: 0 };\n    const childElement = contentRef.current?.firstElementChild as HTMLElement;\n    const height = childElement?.offsetHeight ?? 0;\n    const width = childElement?.offsetWidth ?? 0;\n    return {\n      padding: {\n        top: height,\n        left: width,\n        right: width,\n        bottom: height,\n      },\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [visible, overlayRef]);\n\n  const { styles, attributes, update } = usePopper(triggerRef, overlayRef, {\n    placement: placementMap[placement],\n    onFirstUpdate: onPopperFirstUpdate,\n    modifiers: [\n      {\n        name: 'flip',\n        options: {\n          ...popperOptions,\n        },\n      },\n    ],\n  });\n\n  const defaultStyles = useMemo(() => {\n    if (triggerRef && typeof overlayStyle === 'function') return { ...overlayStyle(triggerRef), zIndex };\n    return { ...overlayStyle, zIndex };\n  }, [overlayStyle, zIndex, triggerRef]);\n\n  // 设置 style 决定展示与隐藏\n  const overlayVisibleStyle: CSSProperties = defaultStyles;\n\n  const triggerNodeTemp = useMemo(() => {\n    const [triggerChildNode] = React.Children.toArray(children);\n\n    if (React.Children.count(children) === 1 && isValidElement(triggerChildNode)) {\n      return triggerChildNode;\n    }\n    return <span className={`${classPrefix}-trigger`}>{children}</span>;\n  }, [children, classPrefix]);\n\n  const [triggerProps, popupProps] = useTriggerProps(\n    { current: overlayRef },\n    { current: triggerRef },\n    [trigger],\n    visible,\n    setVisible,\n    disabled,\n    triggerNodeTemp,\n  );\n\n  // 触发器只能有一个元素\n  const disabledClassName = classNames({ [`${classPrefix}-is-disabled`]: disabled });\n\n  // 代理 trigger 的 ref\n  const triggerNode = cloneElement(triggerNodeTemp, {\n    ref: composeRefs((triggerNodeTemp as any).ref, setTriggerRef),\n    className: classNames(disabledClassName, triggerNodeTemp.props.className),\n    ...triggerProps,\n  });\n\n  const cssTransitionState = usePopupCssTransition({ contentRef, classPrefix, expandAnimation });\n\n  // 弹出框展示的时候，重新计算一下位置\n  useEffect(() => {\n    if ((visible || firstUpdate) && update) {\n      update();\n    }\n  }, [visible, preVisible, update, children, firstUpdate]);\n\n  const handlePopupWrapperMouseDown = () => {\n    const removeUpdate = () => window.removeEventListener('mousemove', update);\n    window.removeEventListener('mouseup', removeUpdate);\n    window.addEventListener('mousemove', update);\n    window.addEventListener('mouseup', removeUpdate);\n  };\n\n  // 初次不渲染.\n  const portal =\n    visible || overlayRef ? (\n      <Portal attach={attach}>\n        <CSSTransition in={visible} appear={true} unmountOnExit={destroyOnClose} {...cssTransitionState.props}>\n          <div\n            ref={composeRefs(setOverlayRef, ref)}\n            style={styles.popper}\n            className={`${classPrefix}-popup`}\n            {...attributes.popper}\n            {...popupProps}\n          >\n            <div\n              className={classNames(`${classPrefix}-popup__content`, overlayClassName, {\n                [`${classPrefix}-popup__content--arrow`]: showArrow,\n              })}\n              style={overlayVisibleStyle}\n              ref={contentRef}\n            >\n              {showArrow ? <div style={styles.arrow} className={`${classPrefix}-popup__arrow`} /> : null}\n              {content}\n            </div>\n          </div>\n        </CSSTransition>\n      </Portal>\n    ) : null;\n\n  return (\n    <div\n      className={classNames(`${classPrefix}-popup__reference`, className)}\n      onMouseDown={handlePopupWrapperMouseDown}\n      style={style}\n    >\n      {triggerNode}\n      {portal}\n    </div>\n  );\n});\n\nPopup.displayName = 'Popup';\n\nexport default Popup;\n"],"names":["placementMap","top","bottom","left","right","Popup","forwardRef","props","ref","trigger","content","placement","attach","showArrow","destroyOnClose","className","style","overlayClassName","overlayStyle","triggerElement","children","disabled","defaultVisible","zIndex","onVisibleChange","expandAnimation","useConfig","classPrefix","useDefault","visible","setVisible","preVisible","usePrevious","useState","triggerRef","setTriggerRef","overlayRef","setOverlayRef","contentRef","useRef","firstUpdate","setFirstUpdate","onPopperFirstUpdate","useMemo","popperOptions","padding","childElement","current","firstElementChild","height","offsetHeight","width","offsetWidth","usePopper","onFirstUpdate","modifiers","name","options","styles","attributes","update","defaultStyles","overlayVisibleStyle","triggerNodeTemp","React","Children","toArray","triggerChildNode","count","isValidElement","createElement","useTriggerProps","triggerProps","popupProps","disabledClassName","classNames","triggerNode","cloneElement","composeRefs","cssTransitionState","usePopupCssTransition","useEffect","handlePopupWrapperMouseDown","removeUpdate","window","removeEventListener","addEventListener","portal","Portal","CSSTransition","appear","unmountOnExit","popper","arrow","onMouseDown","displayName"],"mappings":"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"}