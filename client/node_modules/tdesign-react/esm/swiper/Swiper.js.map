{"version":3,"file":"Swiper.js","sources":["../../src/swiper/Swiper.tsx"],"sourcesContent":["import React, { useState, useEffect, useCallback, useMemo, useRef } from 'react';\nimport classnames from 'classnames';\nimport useConfig from '../_util/useConfig';\nimport noop from '../_util/noop';\nimport { TdSwiperProps, SwiperChangeSource } from './type';\nimport { StyledProps } from '../common';\n\nimport SwiperItem from './SwiperItem';\n\nexport interface SwiperProps extends TdSwiperProps, StyledProps {\n  children?: React.ReactNode;\n}\n\nconst Swiper = (props: SwiperProps) => {\n  const {\n    // animation = 'slide', // 轮播切换动画效果类型（暂时没用）\n    autoplay = true, // 是否自动播放\n    current, // 当前轮播在哪一项（下标）\n    defaultCurrent = 0, // 当前轮播在哪一项（下标），非受控属性\n    direction = 'horizontal', // 轮播滑动方向，包括横向滑动和纵向滑动两个方向\n    duration = 300, // 滑动动画时长\n    interval = 5000, // 轮播间隔时间\n    onChange = noop, // 轮播切换时触发\n    className,\n    children,\n  } = props;\n  const { classPrefix } = useConfig();\n\n  const [currentIndex, setCurrentIndex] = useState(defaultCurrent);\n  const [animation, setAnimation] = useState(true);\n  const swiperTimer = useRef(null); // 计时器指针\n  const isHovering = useRef(false);\n  const wrapperRef = useRef<HTMLDivElement>(null);\n\n  // 进行子组件筛选，创建子节点列表\n  const childrenList = useMemo(\n    () =>\n      React.Children.toArray(children).filter(\n        (child: JSX.Element) => child.type.displayName === SwiperItem.displayName,\n      ),\n    [children],\n  );\n  const childrenLength = childrenList.length;\n\n  // 创建渲染用的节点列表\n  const swiperItemList = childrenList.map((child: JSX.Element, index: number) =>\n    React.cloneElement(child, { value: index, ...child.props }),\n  );\n  // 子节点不为空时，复制第一个子节点到列表最后\n  if (childrenLength > 0) {\n    const firstEle = swiperItemList[0];\n    swiperItemList.push(React.cloneElement(firstEle, { ...firstEle.props, key: `${firstEle.key}-cloned` }));\n  }\n  const swiperItemLength = swiperItemList.length;\n\n  // 统一跳转处理函数\n  const swiperTo = useCallback(\n    (index: number, context: { source: SwiperChangeSource }) => {\n      // 事件通知\n      onChange(index % childrenLength, context);\n      // 设置内部 index\n      setAnimation(true);\n      setCurrentIndex(index);\n    },\n    [childrenLength, onChange],\n  );\n\n  // 定时器\n  const setTimer = useCallback(() => {\n    if (autoplay && interval > 0) {\n      swiperTimer.current = setTimeout(\n        () => {\n          swiperTo(currentIndex + 1, { source: 'autoplay' });\n        },\n        currentIndex === 0 ? interval - (duration + 50) : interval, // 当 index 为 0 的时候，表明刚从克隆的最后一项跳转过来，已经经历了duration + 50 的间隔时间，减去即可\n      );\n    }\n  }, [autoplay, currentIndex, duration, interval, swiperTo]);\n  const clearTimer = useCallback(() => {\n    if (swiperTimer.current) {\n      clearTimeout(swiperTimer.current);\n      swiperTimer.current = null;\n    }\n  }, []);\n\n  // 监听 current 参数变化\n  useEffect(() => {\n    if (current !== undefined) {\n      swiperTo(current % childrenLength, { source: '' });\n    }\n  }, [current, childrenLength, swiperTo]);\n\n  // 在非鼠标 hover 状态时，添加切换下一个组件的定时器\n  useEffect(() => {\n    // 设置自动播放的定时器\n    if (!isHovering.current) {\n      clearTimer();\n      setTimer();\n    }\n  }, [clearTimer, setTimer]);\n\n  // 动画完成后取消 css 属性\n  useEffect(() => {\n    setTimeout(() => {\n      setAnimation(false);\n      if (currentIndex + 1 >= swiperItemLength) {\n        setCurrentIndex(0);\n      }\n    }, duration + 50); // 多 50ms 的间隔时间参考了 react-slick 的动画间隔取值\n  }, [currentIndex, swiperItemLength, duration, direction]);\n\n  // 鼠标移入移出事件\n  const onMouseEnter = () => {\n    isHovering.current = true;\n    clearTimer();\n  };\n  const onMouseLeave = () => {\n    isHovering.current = false;\n    setTimer();\n  };\n\n  // 构造 css 对象\n  // 加入了 translateZ 属性是为了使移动的 div 单独列为一个 layer 以提高滑动性能，参考：https://segmentfault.com/a/1190000010364647\n  let wrapperStyle = {};\n  if (direction === 'vertical') {\n    wrapperStyle = {\n      height: `${swiperItemLength * 100}%`,\n      top: `-${currentIndex * 100}%`,\n      transition: animation ? `top ${duration / 1000}s` : '',\n    };\n  } else {\n    wrapperStyle = {\n      width: `${swiperItemLength * 100}%`,\n      left: `-${currentIndex * 100}%`,\n      transition: animation ? `left ${duration / 1000}s` : '',\n    };\n  }\n\n  return (\n    <div\n      className={classnames(`${classPrefix}-swiper`, className)}\n      onMouseEnter={onMouseEnter}\n      onMouseLeave={onMouseLeave}\n    >\n      {/* 渲染子节点 */}\n      <div className={`${classPrefix}-swiper__content`}>\n        <div ref={wrapperRef} className={`${classPrefix}-swiper__swiper-wrap--${direction}`} style={wrapperStyle}>\n          {swiperItemList}\n        </div>\n      </div>\n      {/* 渲染右侧切换小点 */}\n      <ul className={`${classPrefix}-swiper__trigger-wrap`}>\n        {childrenList.map((_: JSX.Element, i: number) => (\n          <li\n            key={i}\n            className={i === currentIndex % childrenLength ? `${classPrefix}-swiper__trigger--active` : ''}\n            onClick={() => swiperTo(i, { source: 'touch' })}\n          />\n        ))}\n      </ul>\n    </div>\n  );\n};\n\nSwiper.SwiperItem = SwiperItem;\nSwiper.displayName = 'Swiper';\n\nexport default Swiper;\n"],"names":["Swiper","props","autoplay","current","defaultCurrent","direction","duration","interval","onChange","noop","className","children","useConfig","classPrefix","useState","currentIndex","setCurrentIndex","animation","setAnimation","swiperTimer","useRef","isHovering","wrapperRef","childrenList","useMemo","React","Children","toArray","filter","child","type","displayName","SwiperItem","childrenLength","length","swiperItemList","map","index","cloneElement","value","firstEle","push","key","swiperItemLength","swiperTo","useCallback","context","setTimer","setTimeout","source","clearTimer","clearTimeout","useEffect","onMouseEnter","onMouseLeave","wrapperStyle","height","top","transition","width","left","createElement","classnames","ref","style","_","i","onClick"],"mappings":"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"}