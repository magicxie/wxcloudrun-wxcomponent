/**
 * tdesign v0.22.1
 * (c) 2022 tdesign
 * @license MIT
 */

import { _ as _defineProperty } from '../_chunks/dep-9332bbea.js';
import { _ as _slicedToArray } from '../_chunks/dep-93971e86.js';
import { _ as _objectWithoutProperties } from '../_chunks/dep-27d690ce.js';
import React, { forwardRef, useState, useMemo, useCallback, useEffect } from 'react';
import classNames from 'classnames';
import useConfig from '../_util/useConfig.js';
import useCommonClassName from '../_util/useCommonClassName.js';
import useUpdateEffect from '../_util/useUpdateEffect.js';
import StepHandler from './StepHandler.js';
import { isInvalidNumber, strToNumber, getNumberPrecision } from './utils/numberUtils.js';
import { Input } from '../input/index.js';
import '../_chunks/dep-beac373a.js';
import '../config-provider/ConfigContext.js';
import '../locale/zh_CN.js';
import 'tdesign-icons-react';
import '../button/index.js';
import '../button/Button.js';
import '../_util/noop.js';
import '../_util/useRipple.js';
import '../_util/setStyle.js';
import '../loading/index.js';
import '../loading/loading.js';
import '../_util/dom.js';
import 'raf';
import '../_chunks/dep-f3f6eedc.js';
import '../_chunks/dep-c6576f8f.js';
import '../_chunks/dep-156c830d.js';
import '../_chunks/dep-04305406.js';
import '../_chunks/dep-6ca758b4.js';
import '../_util/easing.js';
import '../common/Portal.js';
import 'react-dom';
import '../loading/gradient.js';
import '../loading/plugin.js';
import '../input/Input.js';
import '../_chunks/dep-a347fb20.js';
import '../_chunks/dep-b33ecffe.js';
import '../_util/forwardRefWithStatics.js';
import 'hoist-non-react-statics';
import '../input/InputGroup.js';
import '../_util/useDefaultValue.js';
import '../_util/useDefault.js';

var _excluded = ["className", "style", "defaultValue", "value", "disabled", "size", "theme", "step", "max", "min", "decimalPlaces", "format", "onChange", "onBlur", "onFocus", "onEnter", "onKeydown", "onKeyup", "onKeypress"],
    _excluded2 = ["value"];

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { _defineProperty(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }
var InputNumber = /*#__PURE__*/forwardRef(function (props, ref) {
  var _classNames;

  var className = props.className,
      style = props.style,
      defaultValue = props.defaultValue,
      value = props.value,
      _props$disabled = props.disabled,
      disabled = _props$disabled === void 0 ? false : _props$disabled,
      _props$size = props.size,
      size = _props$size === void 0 ? "medium" : _props$size,
      _props$theme = props.theme,
      theme = _props$theme === void 0 ? "row" : _props$theme,
      _props$step = props.step,
      step = _props$step === void 0 ? 1 : _props$step,
      _props$max = props.max,
      max = _props$max === void 0 ? Number.MAX_SAFE_INTEGER : _props$max,
      _props$min = props.min,
      min = _props$min === void 0 ? Number.MIN_SAFE_INTEGER : _props$min,
      decimalPlaces = props.decimalPlaces,
      format = props.format,
      onChange = props.onChange,
      onBlur = props.onBlur,
      onFocus = props.onFocus,
      onEnter = props.onEnter,
      onKeydown = props.onKeydown,
      onKeyup = props.onKeyup,
      onKeypress = props.onKeypress,
      restInputProps = _objectWithoutProperties(props, _excluded);

  var _useConfig = useConfig(),
      classPrefix = _useConfig.classPrefix;

  var commonClassNames = useCommonClassName();
  var componentType = "input-number";
  var inputClassName = "".concat(classPrefix, "-").concat(componentType);

  var getRangeValue = function getRangeValue(value2) {
    if (value2 < min) return min;
    if (value2 > max) return max;
    return value2;
  };

  var _useState = useState(function () {
    var initialValue = "";

    if (!isInvalidNumber(defaultValue)) {
      initialValue = getRangeValue(Number(defaultValue));
    }

    if (!isInvalidNumber(value)) {
      initialValue = value;
    }

    if (format && initialValue !== "") {
      return format(getRangeValue(Number(initialValue))) || "";
    }

    return initialValue;
  }),
      _useState2 = _slicedToArray(_useState, 2),
      internalInputValue = _useState2[0],
      setInternalInputValue = _useState2[1];

  var decimalValue = internalInputValue;

  if (typeof internalInputValue === "string") {
    decimalValue = strToNumber(internalInputValue) || 0;
  }

  var setInputValue = function setInputValue(inputStr) {
    var _format;

    if (["", void 0].includes(inputStr)) {
      return setInternalInputValue("");
    }

    var formattedInputValue = (_format = format === null || format === void 0 ? void 0 : format(Number(inputStr))) !== null && _format !== void 0 ? _format : inputStr;
    setInternalInputValue(formattedInputValue);
  };

  var _useState3 = useState(false),
      _useState4 = _slicedToArray(_useState3, 2),
      isError = _useState4[0],
      setError = _useState4[1];

  var disabledDecrease = disabled || isError || decimalValue - step < min;
  var disabledIncrease = disabled || isError || decimalValue + step > max;

  var isOutOfRange = function isOutOfRange(number) {
    return number > max || number < min;
  };

  var checkInput = function checkInput(inputStr) {
    if (inputStr === "") {
      setError(false);
      return true;
    }

    var hasError = isInvalidNumber(inputStr) || isOutOfRange(Number(inputStr));
    setError(hasError);
    return !hasError;
  };

  var stepPrecision = useMemo(function () {
    return getNumberPrecision(step);
  }, [step]);
  var getPrecision = useCallback(function (str) {
    var numberPrecision = getNumberPrecision(str);
    return decimalPlaces !== null && decimalPlaces !== void 0 ? decimalPlaces : Math.max(numberPrecision, stepPrecision);
  }, [stepPrecision, decimalPlaces]);
  useEffect(function () {
    if (value !== void 0) {
      checkInput(value);
    }
  }, [value]);
  useUpdateEffect(function () {
    setInputValue((value !== null && value !== void 0 ? value : "").toString());
  }, [value]);

  var triggerValueUpdate = function triggerValueUpdate(action) {
    var value2 = action.value,
        context = _objectWithoutProperties(action, _excluded2);

    if (!disabled) {
      onChange === null || onChange === void 0 ? void 0 : onChange(value2, context);
    }
  };

  var onInternalInput = function onInternalInput(inputStr, _ref) {
    var e = _ref.e;

    if (inputStr === "") {
      setInputValue(inputStr);
      return triggerValueUpdate({
        type: "input",
        value: void 0,
        e: e
      });
    }

    var filteredInputStr = strToNumber(inputStr);

    if (Number.isNaN(filteredInputStr)) {
      setInternalInputValue(inputStr);
      if (!checkInput(inputStr)) return;
    }

    setInputValue(filteredInputStr.toString());
    if (!checkInput(filteredInputStr)) return;
    triggerValueUpdate({
      type: "input",
      value: filteredInputStr,
      e: e
    });
  };

  var onInternalStep = function onInternalStep(action) {
    var type = action.type,
        e = action.e;
    var currentValue = decimalValue || 0;
    var precision = getPrecision(currentValue);
    var updateValue;

    switch (type) {
      case "add":
        {
          updateValue = Number((currentValue + step).toFixed(precision));
          break;
        }

      case "reduce":
        {
          updateValue = Number((currentValue - step).toFixed(precision));
          break;
        }
    }

    setInputValue(updateValue);
    triggerValueUpdate({
      value: updateValue,
      type: type,
      e: e
    });
    e.preventDefault();
  };

  var handleBlur = function handleBlur(e) {
    var _updateValue;

    var updateValue;
    var internalFloatValue = parseFloat(internalInputValue);

    if (internalInputValue === "") {
      updateValue = void 0;
    } else if (!Number.isNaN(internalFloatValue)) {
      updateValue = getRangeValue(internalFloatValue);
    } else {
      var checkVal = internalInputValue.replace(/[^0-9]/gi, "");
      updateValue = checkVal;

      if (!checkVal) {
        updateValue = value;
      }
    }

    onBlur === null || onBlur === void 0 ? void 0 : onBlur(updateValue, {
      e: e
    });
    setInputValue(((_updateValue = updateValue) !== null && _updateValue !== void 0 ? _updateValue : "").toString());
    setError(false);

    if (updateValue !== value) {
      triggerValueUpdate({
        value: updateValue,
        e: e,
        type: ""
      });
    }
  };

  var handleFocus = function handleFocus(e) {
    return onFocus === null || onFocus === void 0 ? void 0 : onFocus(decimalValue, {
      e: e
    });
  };

  var handleKeydownEnter = function handleKeydownEnter(e) {
    e.key === "Enter" && (onEnter === null || onEnter === void 0 ? void 0 : onEnter(decimalValue, {
      e: e
    }));
  };

  var handleKeydown = function handleKeydown(e) {
    onKeydown === null || onKeydown === void 0 ? void 0 : onKeydown(decimalValue, {
      e: e
    });
    handleKeydownEnter(e);
  };

  var handleKeyup = function handleKeyup(e) {
    return onKeyup === null || onKeyup === void 0 ? void 0 : onKeyup(decimalValue, {
      e: e
    });
  };

  var handleKeypress = function handleKeypress(e) {
    return onKeypress === null || onKeypress === void 0 ? void 0 : onKeypress(decimalValue, {
      e: e
    });
  };

  return /* @__PURE__ */React.createElement("div", {
    ref: ref,
    className: classNames(className, inputClassName, commonClassNames.SIZE[size], (_classNames = {}, _defineProperty(_classNames, commonClassNames.STATUS.disabled, disabled), _defineProperty(_classNames, "".concat(classPrefix, "-is-controls-right"), theme === "column"), _defineProperty(_classNames, "".concat(inputClassName, "--").concat(theme), theme), _classNames)),
    style: style,
    onBlur: handleBlur,
    onFocus: handleFocus,
    onKeyDown: handleKeydown,
    onKeyUp: handleKeyup,
    onKeyPress: handleKeypress
  }, theme !== "normal" && /* @__PURE__ */React.createElement(StepHandler, {
    prefixClassName: inputClassName,
    theme: theme,
    disabledDecrease: disabledDecrease,
    disabledIncrease: disabledIncrease,
    onStep: onInternalStep
  }), /* @__PURE__ */React.createElement(Input, _objectSpread({
    disabled: disabled,
    value: internalInputValue,
    onChange: onInternalInput,
    status: isError ? "error" : void 0
  }, restInputProps)));
});
InputNumber.displayName = "InputNumber";

export { InputNumber as default };
//# sourceMappingURL=InputNumber.js.map
