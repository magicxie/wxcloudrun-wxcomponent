/**
 * tdesign v0.22.1
 * (c) 2022 tdesign
 * @license MIT
 */

import { _ as _defineProperty } from '../../_chunks/dep-9332bbea.js';
import { _ as _slicedToArray } from '../../_chunks/dep-93971e86.js';
import React, { useState, useRef, useMemo, useEffect } from 'react';
import { CloseCircleFilledIcon } from 'tdesign-icons-react';
import classNames from 'classnames';
import { i as isFunction_1 } from '../../_chunks/dep-a347fb20.js';
import { g as get_1 } from '../../_chunks/dep-623f5502.js';
import { i as isString_1 } from '../../_chunks/dep-f3f6eedc.js';
import { isNumber } from 'lodash';
import { useLocaleReceiver } from '../../locale/LocalReceiver.js';
import useConfig from '../../_util/useConfig.js';
import composeRefs from '../../_util/composeRefs.js';
import useDefaultValue from '../../_util/useDefaultValue.js';
import forwardRefWithStatics from '../../_util/forwardRefWithStatics.js';
import { getValueToOption, getSelectValueArr, getMultipleTags } from '../util/helper.js';
import noop from '../../_util/noop.js';
import FakeArrow from '../../common/FakeArrow.js';
import { Loading } from '../../loading/index.js';
import { Input } from '../../input/index.js';
import { Popup } from '../../popup/index.js';
import { Tag } from '../../tag/index.js';
import Option from './Option.js';
import OptionGroup from './OptionGroup.js';
import PopupContent from './PopupContent.js';
import '../../_chunks/dep-beac373a.js';
import '../../_chunks/dep-c6576f8f.js';
import '../../_chunks/dep-156c830d.js';
import '../../_chunks/dep-b33ecffe.js';
import '../../_chunks/dep-734d525f.js';
import '../../_chunks/dep-04305406.js';
import '../../_chunks/dep-7cf92957.js';
import '../../_chunks/dep-6ca758b4.js';
import '../../_chunks/dep-a554e9c2.js';
import '../../_chunks/dep-0268bf88.js';
import '../../_chunks/dep-76c67131.js';
import '../../config-provider/ConfigContext.js';
import '../../locale/zh_CN.js';
import '../../_chunks/dep-27d690ce.js';
import '../../_util/useDefault.js';
import 'hoist-non-react-statics';
import '../../_chunks/dep-124f91c5.js';
import '../../loading/loading.js';
import '../../_util/dom.js';
import 'raf';
import '../../_util/easing.js';
import '../../common/Portal.js';
import 'react-dom';
import '../../loading/gradient.js';
import '../../loading/plugin.js';
import '../../input/Input.js';
import '../../input/InputGroup.js';
import '../../popup/Popup.js';
import 'react-transition-group';
import 'react-popper';
import '../../_util/usePrevious.js';
import '../../popup/Portal.js';
import '../../popup/hooks/useTriggerProps.js';
import '../../_util/useClickOutside.js';
import '../../popup/hooks/usePopupCssTransition.js';
import '../../tag/Tag.js';
import '../../tag/CheckTag.js';
import '../../_chunks/dep-e2a4740c.js';
import '../../_util/useRipple.js';
import '../../_util/setStyle.js';

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { _defineProperty(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }
var MAX_OVERLAY_WIDTH = 500;
var Select = forwardRefWithStatics(function (props, ref) {
  var _classNames3;

  var _useLocaleReceiver = useLocaleReceiver("select"),
      _useLocaleReceiver2 = _slicedToArray(_useLocaleReceiver, 2),
      local = _useLocaleReceiver2[0],
      t = _useLocaleReceiver2[1];

  var emptyText = t(local.loadingText);

  var _useDefaultValue = useDefaultValue(props),
      _useDefaultValue$bord = _useDefaultValue.bordered,
      bordered = _useDefaultValue$bord === void 0 ? true : _useDefaultValue$bord,
      creatable = _useDefaultValue.creatable,
      filter = _useDefaultValue.filter,
      _useDefaultValue$load = _useDefaultValue.loadingText,
      loadingText = _useDefaultValue$load === void 0 ? emptyText : _useDefaultValue$load,
      _useDefaultValue$max = _useDefaultValue.max,
      max = _useDefaultValue$max === void 0 ? 0 : _useDefaultValue$max,
      popupProps = _useDefaultValue.popupProps,
      reserveKeyword = _useDefaultValue.reserveKeyword,
      value = _useDefaultValue.value,
      className = _useDefaultValue.className,
      style = _useDefaultValue.style,
      disabled = _useDefaultValue.disabled,
      size = _useDefaultValue.size,
      multiple = _useDefaultValue.multiple,
      placeholder = _useDefaultValue.placeholder,
      clearable = _useDefaultValue.clearable,
      prefixIcon = _useDefaultValue.prefixIcon,
      options = _useDefaultValue.options,
      filterable = _useDefaultValue.filterable,
      loading = _useDefaultValue.loading,
      _onFocus = _useDefaultValue.onFocus,
      _onBlur = _useDefaultValue.onBlur,
      _useDefaultValue$onCl = _useDefaultValue.onClear,
      onClear = _useDefaultValue$onCl === void 0 ? noop : _useDefaultValue$onCl,
      onCreate = _useDefaultValue.onCreate,
      onRemove = _useDefaultValue.onRemove,
      onSearch = _useDefaultValue.onSearch,
      onChange = _useDefaultValue.onChange,
      empty = _useDefaultValue.empty,
      _useDefaultValue$valu = _useDefaultValue.valueType,
      valueType = _useDefaultValue$valu === void 0 ? "value" : _useDefaultValue$valu,
      keys = _useDefaultValue.keys,
      children = _useDefaultValue.children,
      collapsedItems = _useDefaultValue.collapsedItems,
      minCollapsedNum = _useDefaultValue.minCollapsedNum,
      valueDisplay = _useDefaultValue.valueDisplay,
      _onEnter = _useDefaultValue.onEnter,
      onVisibleChange = _useDefaultValue.onVisibleChange;

  var _useConfig = useConfig(),
      classPrefix = _useConfig.classPrefix;

  var name = "".concat(classPrefix, "-select");

  var _useState = useState(false),
      _useState2 = _slicedToArray(_useState, 2),
      showPopup = _useState2[0],
      setShowPopup = _useState2[1];

  var _useState3 = useState(false),
      _useState4 = _slicedToArray(_useState3, 2),
      isHover = _useState4[0],
      toggleHover = _useState4[1];

  var _useState5 = useState(void 0),
      _useState6 = _slicedToArray(_useState5, 2),
      inputVal = _useState6[0],
      setInputVal = _useState6[1];

  var _useState7 = useState([]),
      _useState8 = _slicedToArray(_useState7, 2),
      currentOptions = _useState8[0],
      setCurrentOptions = _useState8[1];

  var _useState9 = useState([]),
      _useState10 = _slicedToArray(_useState9, 2),
      tmpPropOptions = _useState10[0],
      setTmpPropOptions = _useState10[1];

  var _useState11 = useState({}),
      _useState12 = _slicedToArray(_useState11, 2),
      valueToOption = _useState12[0],
      setValueToOption = _useState12[1];

  var _useState13 = useState([]),
      _useState14 = _slicedToArray(_useState13, 2),
      selectedOptions = _useState14[0],
      setSelectedOptions = _useState14[1];

  var _useState15 = useState(0),
      _useState16 = _slicedToArray(_useState15, 2),
      width = _useState16[0],
      setWidth = _useState16[1];

  var selectRef = useRef(null);
  var overlayRef = useRef(null);
  var selectedLabel = useMemo(function () {
    return get_1(selectedOptions[0] || {}, (keys === null || keys === void 0 ? void 0 : keys.label) || "label") || "";
  }, [selectedOptions, keys]);
  useEffect(function () {
    if (showPopup && selectRef !== null && selectRef !== void 0 && selectRef.current) {
      var _overlayRef$current, _overlayRef$current$g;

      var domRect = selectRef.current.getBoundingClientRect();
      var overlayRect = overlayRef === null || overlayRef === void 0 ? void 0 : (_overlayRef$current = overlayRef.current) === null || _overlayRef$current === void 0 ? void 0 : (_overlayRef$current$g = _overlayRef$current.getBoundingClientRect) === null || _overlayRef$current$g === void 0 ? void 0 : _overlayRef$current$g.call(_overlayRef$current);
      var width2 = domRect.width > MAX_OVERLAY_WIDTH ? domRect.width : Math.min(MAX_OVERLAY_WIDTH, Math.max(domRect.width, overlayRect === null || overlayRect === void 0 ? void 0 : overlayRect.width));
      setWidth(width2);
    }
  }, [showPopup]);

  var handleShowPopup = function handleShowPopup(visible) {
    if (disabled) return;
    setShowPopup(visible);
    onVisibleChange === null || onVisibleChange === void 0 ? void 0 : onVisibleChange(visible);

    if (!visible && !multiple && filterable) {
      setInputVal(selectedLabel);
    }
  };

  useEffect(function () {
    if (keys) {
      var transformedOptions = options.map(function (option) {
        return _objectSpread(_objectSpread({}, option), {}, {
          value: get_1(option, (keys === null || keys === void 0 ? void 0 : keys.value) || "value"),
          label: get_1(option, (keys === null || keys === void 0 ? void 0 : keys.label) || "label")
        });
      });
      setCurrentOptions(transformedOptions);
      setTmpPropOptions(transformedOptions);
    } else {
      setCurrentOptions(options);
      setTmpPropOptions(options);
    }

    setValueToOption(getValueToOption(children, options, keys) || {});
  }, [options, keys, children]);
  useEffect(function () {
    setSelectedOptions(function (oldSelectedOptions) {
      var valueKey = (keys === null || keys === void 0 ? void 0 : keys.value) || "value";
      var labelKey = (keys === null || keys === void 0 ? void 0 : keys.label) || "label";

      if (Array.isArray(value)) {
        return value.map(function (item) {
          if (valueType === "value") {
            var _ref;

            return valueToOption[item] || oldSelectedOptions.find(function (option) {
              return get_1(option, valueKey) === item;
            }) || (_ref = {}, _defineProperty(_ref, valueKey, item), _defineProperty(_ref, labelKey, item), _ref);
          }

          return item;
        }).filter(Boolean);
      }

      if (value !== void 0 && value !== null) {
        if (valueType === "value") {
          var _ref2;

          return [valueToOption[value] || oldSelectedOptions.find(function (option) {
            return get_1(option, valueKey) === value;
          }) || (_ref2 = {}, _defineProperty(_ref2, valueKey, value), _defineProperty(_ref2, labelKey, value), _ref2)].filter(Boolean);
        }

        return [value];
      }

      return [];
    });
  }, [value, keys, valueType, valueToOption]);

  var removeTag = function removeTag(event, selectValue, tagData) {
    event.stopPropagation();
    var values = getSelectValueArr(value, selectValue, true, valueType, keys);
    onChange(values);

    if (isFunction_1(onRemove)) {
      onRemove({
        value: tagData.value,
        data: tagData,
        e: event
      });
    }
  };

  var handleChange = function handleChange(value2, _ref3) {
    var label = _ref3.label;

    if (filterable) {
      setInputVal(!multiple || reserveKeyword && multiple ? label : "");
    }

    if (creatable && isFunction_1(onCreate)) {
      if (options.filter(function (option) {
        return option.value === value2;
      }).length === 0) {
        onCreate(value2);
      }
    }

    onChange(value2);
  };

  var handleFilter = function handleFilter(value2) {
    var filteredOptions;

    if (!value2) {
      setCurrentOptions(tmpPropOptions);
      return;
    }

    if (filter && isFunction_1(filter)) {
      filteredOptions = Array.isArray(tmpPropOptions) && tmpPropOptions.filter(function (option) {
        return filter(value2, option);
      });
    } else {
      var filterRegExp = new RegExp(value2, "i");
      filteredOptions = Array.isArray(tmpPropOptions) && tmpPropOptions.filter(function (option) {
        return filterRegExp.test(option === null || option === void 0 ? void 0 : option.label);
      });
    }

    if (creatable) {
      filteredOptions = filteredOptions.concat([{
        label: value2,
        value: value2
      }]);
    }

    setCurrentOptions(filteredOptions);
  };

  var handleInputChange = function handleInputChange(value2) {
    setInputVal(value2);

    if (isFunction_1(onSearch)) {
      onSearch(value2);
      return;
    }

    handleFilter(value2);
  };

  var defaultLabel = /* @__PURE__ */React.createElement("span", {
    className: classNames(className, _defineProperty({}, "".concat(name, "__placeholder"), !value && !isNumber(value) || Array.isArray(value) && value.length < 1), _defineProperty({}, "".concat(name, "__single"), selectedLabel))
  }, selectedLabel || placeholder || "-\u8BF7\u9009\u62E9-");

  var renderMultipleTags = function renderMultipleTags() {
    if (multiple && Array.isArray(value) && value.length > 0) {
      var tags;

      if (valueType === "value") {
        tags = getMultipleTags(selectedOptions, keys);
      } else {
        tags = getMultipleTags(value, keys);
      }

      if (tags.length > 0) return /* @__PURE__ */React.createElement(React.Fragment, null, tags.slice(0, minCollapsedNum).map(function (item) {
        return /* @__PURE__ */React.createElement(Tag, {
          closable: !disabled,
          key: item.value,
          onClose: function onClose(_ref4) {
            var e = _ref4.e;
            return removeTag(e, item.value, item);
          },
          disabled: disabled,
          size: size
        }, item.label);
      }), collapsedItems, minCollapsedNum && tags.length - minCollapsedNum > 0 && !collapsedItems ? /* @__PURE__ */React.createElement(Tag, {
        size: size
      }, " ", "+".concat(tags.length - minCollapsedNum)) : null);
      return !filterable ? defaultLabel : null;
    }

    return !filterable ? defaultLabel : null;
  };

  var renderInput = function renderInput() {
    return /* @__PURE__ */React.createElement(Input, {
      value: isString_1(inputVal) ? inputVal : selectedLabel,
      placeholder: multiple && get_1(value, "length") > 0 ? null : selectedLabel || placeholder || "-\u8BF7\u9009\u62E9-",
      className: "".concat(name, "__input"),
      onChange: handleInputChange,
      size: size,
      onFocus: function onFocus(_, context) {
        return _onFocus === null || _onFocus === void 0 ? void 0 : _onFocus({
          value: value,
          e: context === null || context === void 0 ? void 0 : context.e
        });
      },
      onBlur: function onBlur(_, context) {
        return _onBlur === null || _onBlur === void 0 ? void 0 : _onBlur({
          value: value,
          e: context === null || context === void 0 ? void 0 : context.e
        });
      },
      onEnter: function onEnter(_, context) {
        return _onEnter === null || _onEnter === void 0 ? void 0 : _onEnter({
          inputValue: inputVal,
          value: value,
          e: context === null || context === void 0 ? void 0 : context.e
        });
      }
    });
  };

  var onInputClick = function onInputClick(e) {
    e.preventDefault();

    if (!disabled) {
      setShowPopup(!showPopup);
      setInputVal("");
    }
  };

  var onClearValue = function onClearValue(event) {
    event.stopPropagation();

    if (Array.isArray(value)) {
      onChange([]);
    } else {
      onChange("");
    }

    setInputVal(void 0);
    onClear({
      e: event
    });
  };

  var renderSuffixIcon = function renderSuffixIcon() {
    if (loading) {
      return /* @__PURE__ */React.createElement(Loading, {
        className: classNames(className, "".concat(name, "__right-icon"), "".concat(name, "__active-icon")),
        loading: true,
        size: "small"
      });
    }

    if (clearable && value && isHover) {
      return /* @__PURE__ */React.createElement(CloseCircleFilledIcon, {
        onClick: clearable ? onClearValue : void 0,
        className: classNames(className, "".concat(name, "__right-icon"), "".concat(name, "__right-icon-clear"))
      });
    }

    return /* @__PURE__ */React.createElement(FakeArrow, {
      overlayClassName: "".concat(name, "__right-icon"),
      isActive: showPopup,
      disabled: disabled
    });
  };

  var popupContentProps = {
    onChange: handleChange,
    value: value,
    className: className,
    size: size,
    multiple: multiple,
    showPopup: showPopup,
    setShowPopup: setShowPopup,
    options: currentOptions,
    empty: empty,
    max: max,
    loadingText: loadingText,
    loading: loading,
    valueType: valueType,
    keys: keys
  };

  var renderContent = function renderContent() {
    return /* @__PURE__ */React.createElement(PopupContent, _objectSpread({}, popupContentProps), children);
  };

  var renderMultipleInput = function renderMultipleInput() {
    if (valueDisplay) {
      return valueDisplay({
        value: value,
        onClose: removeTag
      }) || defaultLabel;
    }

    return renderMultipleTags();
  };

  return /* @__PURE__ */React.createElement("div", {
    className: "".concat(name, "__wrap"),
    style: _objectSpread({}, style),
    onMouseEnter: function onMouseEnter() {
      return toggleHover(true);
    },
    onMouseLeave: function onMouseLeave() {
      return toggleHover(false);
    }
  }, /* @__PURE__ */React.createElement(Popup, _objectSpread({
    trigger: "click",
    ref: overlayRef,
    content: renderContent(),
    placement: "bottom-left",
    visible: showPopup,
    overlayStyle: {
      width: width ? "".concat(width, "px") : "none"
    },
    onVisibleChange: handleShowPopup,
    overlayClassName: classNames(className, "".concat(name, "__dropdown"), "".concat(classPrefix, "-popup"), "narrow-scrollbar"),
    className: "".concat(name, "__popup-reference"),
    expandAnimation: true,
    destroyOnClose: true
  }, popupProps), /* @__PURE__ */React.createElement("div", {
    className: classNames(className, name, (_classNames3 = {}, _defineProperty(_classNames3, "".concat(classPrefix, "-is-disabled"), disabled), _defineProperty(_classNames3, "".concat(classPrefix, "-is-active"), showPopup), _defineProperty(_classNames3, "".concat(classPrefix, "-size-s"), size === "small"), _defineProperty(_classNames3, "".concat(classPrefix, "-size-l"), size === "large"), _defineProperty(_classNames3, "".concat(classPrefix, "-no-border"), !bordered), _defineProperty(_classNames3, "".concat(classPrefix, "-has-prefix"), !!prefixIcon), _classNames3)),
    ref: composeRefs(selectRef, ref),
    style: {
      userSelect: "none"
    },
    onClick: onInputClick
  }, /* @__PURE__ */React.createElement("span", {
    className: "".concat(name, "__left-icon")
  }, prefixIcon), multiple ? renderMultipleInput() : null, filterable && renderInput(), !multiple && !filterable && defaultLabel, renderSuffixIcon())));
}, {
  displayName: "Select",
  Option: Option,
  OptionGroup: OptionGroup
});

export { Select as default };
//# sourceMappingURL=Select.js.map
