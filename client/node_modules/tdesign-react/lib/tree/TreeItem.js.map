{"version":3,"file":"TreeItem.js","sources":["../../src/tree/TreeItem.tsx"],"sourcesContent":["import React, { forwardRef, MouseEvent, ReactNode, useRef } from 'react';\nimport classNames from 'classnames';\nimport { CaretRightSmallIcon } from 'tdesign-icons-react';\nimport Loading from '../loading';\nimport useRipple from '../_util/useRipple';\nimport TreeNode from '../_common/js/tree/tree-node';\nimport Checkbox from '../checkbox';\nimport { useTreeConfig } from './useTreeConfig';\nimport { TreeItemProps } from './interface';\n\n/**\n * 树节点组件\n */\nconst TreeItem = forwardRef((props: TreeItemProps, ref: React.Ref<HTMLDivElement>) => {\n  const {\n    node,\n    icon,\n    label,\n    line,\n    expandOnClickNode,\n    activable,\n    checkProps,\n    disableCheck,\n    operations,\n    onClick,\n    onChange,\n  } = props;\n  const { level } = node;\n\n  const { treeClassNames } = useTreeConfig();\n\n  const handleClick = (evt: MouseEvent<HTMLDivElement>) => {\n    onClick?.(node, {\n      event: evt,\n      expand: expandOnClickNode,\n      active: activable,\n    });\n  };\n\n  const handleItemClick = (evt: MouseEvent<HTMLDivElement>) => {\n    if (node.loading) {\n      return;\n    }\n    onClick?.(node, {\n      event: evt,\n      expand: true,\n      active: false,\n    });\n  };\n\n  const handleIconClick = (evt: MouseEvent<HTMLDivElement>) => {\n    evt.stopPropagation();\n    handleItemClick(evt);\n  };\n\n  const stopPropagation = (e: MouseEvent) => {\n    e.stopPropagation();\n  };\n\n  /* ======== render ======= */\n  const renderIcon = () => {\n    // 这里按 vue 的逻辑定义\n    let isDefaultIcon = false;\n    const renderIconNode = () => {\n      if (icon === false) {\n        return null;\n      }\n      if (icon instanceof Function) {\n        return icon(node.getModel());\n      }\n      if (React.isValidElement(icon)) {\n        return icon;\n      }\n      if (icon && icon !== true) {\n        // 非 ReactNode、Function、Boolean 类型，抛出错误提示\n        throw new Error('invalid type of icon');\n      }\n\n      if (!node.isLeaf()) {\n        isDefaultIcon = true;\n        if (node.loading && node.expanded) {\n          return <Loading loading={true} />;\n        }\n\n        return <CaretRightSmallIcon className={treeClassNames.treeIconRight} />;\n      }\n      return null;\n    };\n\n    const iconNode = renderIconNode();\n    return (\n      <span\n        className={classNames(treeClassNames.treeIcon, treeClassNames.folderIcon, {\n          [treeClassNames.treeIconDefault]: isDefaultIcon,\n        })}\n        onClick={handleIconClick}\n      >\n        {iconNode}\n      </span>\n    );\n  };\n\n  const renderLine = () => {\n    const iconVisible = icon !== false;\n\n    if (line === false) {\n      return null;\n    }\n\n    if (line instanceof Function) {\n      return line(node.getModel());\n    }\n\n    if (React.isValidElement(line)) {\n      return line;\n    }\n\n    if (node.parent && node.tree) {\n      // 如果节点的父节点，不是最后的节点\n      // 则需要绘制节点延长线\n      const shadowStyles: string[] = [];\n      const parents = node.getParents();\n      parents.pop();\n      parents.forEach((pnode: TreeNode, index: number) => {\n        if (!pnode.vmIsLast) {\n          shadowStyles.push(`calc(-${index + 1} * var(--space)) 0 var(--color)`);\n        }\n      });\n\n      const styles = {\n        '--level': level,\n        boxShadow: shadowStyles.join(','),\n      };\n\n      return (\n        <span\n          className={classNames(\n            // 每个节点绘制抵达上一层级的折线\n            treeClassNames.line,\n            {\n              // 叶子节点，折线宽度延长，因为没有 icon 呈现\n              // 任意节点，icon 不呈现时也是要延长折线宽度\n              [treeClassNames.lineIsLeaf]: node.vmIsLeaf || !iconVisible,\n              // 分支首节点，到上一节点的折线高度要缩短，让位给 icon 呈现\n              // 如果 icon 隐藏了，则不必缩短折线高度\n              [treeClassNames.lineIsFirst]: node.vmIsFirst && iconVisible,\n            },\n          )}\n          style={styles}\n          onClick={stopPropagation}\n        />\n      );\n    }\n    return null;\n  };\n\n  // 使用 斜八角动画\n  const labelRef = useRef();\n  useRipple(labelRef);\n\n  const renderLabel = () => {\n    const emptyView = '暂无数据';\n    let labelText: string | ReactNode = '';\n    if (label instanceof Function) {\n      labelText = label(node.getModel()) || emptyView;\n    } else {\n      labelText = node.label || emptyView;\n    }\n\n    const labelClasses = classNames(treeClassNames.treeLabel, treeClassNames.treeLabelStrictly, {\n      [treeClassNames.actived]: node.isActivable() ? node.actived : false,\n    });\n\n    if (node.isCheckable()) {\n      let checkboxDisabled: boolean;\n      if (typeof disableCheck === 'function') {\n        checkboxDisabled = disableCheck(node.getModel());\n      } else {\n        checkboxDisabled = !!disableCheck;\n      }\n\n      if (node.isDisabled()) {\n        checkboxDisabled = true;\n      }\n\n      return (\n        <Checkbox\n          ref={labelRef}\n          // value={node.value}\n          checked={node.checked}\n          indeterminate={node.indeterminate}\n          disabled={checkboxDisabled}\n          name={String(node.value)}\n          onChange={() => onChange(node)}\n          className={labelClasses}\n          {...checkProps}\n        >\n          <span date-target=\"label\">{labelText}</span>\n        </Checkbox>\n      );\n    }\n    return (\n      <span ref={labelRef} date-target=\"label\" className={labelClasses}>\n        <span style={{ position: 'relative' }}>{labelText}</span>\n      </span>\n    );\n  };\n\n  const renderOperations = () => {\n    let operationsView = null;\n    if (operations) {\n      // ReactNode 类型处理\n      if (React.isValidElement(operations)) {\n        operationsView = operations;\n      } else if (operations instanceof Function) {\n        // Function 类型处理\n        const treeNodeModel = node?.getModel();\n        operationsView = operations(treeNodeModel);\n      } else {\n        // 非 ReactNode、Function 类型，抛出错误提示\n        throw new Error('invalid type of operations');\n      }\n    }\n\n    if (operationsView) {\n      return (\n        <span className={treeClassNames.treeOperations} date-target=\"operations\">\n          {operationsView}\n        </span>\n      );\n    }\n    return null;\n  };\n\n  // ？？这里写两个属性，ts 就不会报错了\n  const styles = {\n    '--level': level,\n    boxShadow: '',\n  };\n\n  return (\n    <div\n      ref={ref}\n      data-value={node.value}\n      data-level={level}\n      className={classNames(treeClassNames.treeNode, {\n        [treeClassNames.treeNodeOpen]: node.expanded,\n        [treeClassNames.actived]: node.isActivable() ? node.actived : false,\n        [treeClassNames.disabled]: node.isDisabled(),\n      })}\n      style={styles}\n      onClick={handleClick}\n    >\n      {renderLine()}\n      {renderIcon()}\n      {renderLabel()}\n      {renderOperations()}\n    </div>\n  );\n});\n\nTreeItem.displayName = 'TreeItem';\n\nexport default TreeItem;\n"],"names":["TreeItem","forwardRef","props","ref","node","icon","label","line","expandOnClickNode","activable","checkProps","disableCheck","operations","onClick","onChange","level","useTreeConfig","treeClassNames","handleClick","evt","event","expand","active","handleItemClick","loading","handleIconClick","stopPropagation","e","renderIcon","isDefaultIcon","renderIconNode","Function","getModel","React","isValidElement","Error","isLeaf","expanded","createElement","Loading","CaretRightSmallIcon","className","treeIconRight","iconNode","classNames","treeIcon","folderIcon","treeIconDefault","renderLine","iconVisible","parent","tree","shadowStyles","parents","getParents","pop","forEach","pnode","index","vmIsLast","push","styles2","boxShadow","join","lineIsLeaf","vmIsLeaf","lineIsFirst","vmIsFirst","style","labelRef","useRef","useRipple","renderLabel","emptyView","labelText","labelClasses","treeLabel","treeLabelStrictly","actived","isActivable","isCheckable","checkboxDisabled","isDisabled","Checkbox","checked","indeterminate","disabled","name","String","value","position","renderOperations","operationsView","treeNodeModel","treeOperations","styles","treeNode","treeNodeOpen","displayName"],"mappings":"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"}